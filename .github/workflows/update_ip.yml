name: 自动优选 IP

on:
  workflow_dispatch:
  schedule:
    - cron: '0 21,00,7,13 * * *'

jobs:
  update_ip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 安装依赖
        run: sudo apt-get update && sudo apt-get install -y jq bc ca-certificates

      - name: 提取并聚合数据
        run: |
          TARGET_FILE="addressesapi.txt"
          TEMP_FILE="temp_ips.txt"
          API_SPEED="https://cf.090227.xyz/ip.164746.xyz"
          API_TOP20="https://vps789.com/openApi/cfIpTop20"
          API_YES="https://cf.090227.xyz/CloudFlareYes"
          
          > $TEMP_FILE

          get_loc_name() {
            case "$1" in
              *HKG*) echo "香港" ;;
              *SJC*) echo "美国" ;;
              *SEA*) echo "美国" ;;
              *SIN*) echo "新加坡" ;;
              *LAX*) echo "美国" ;;
              *NRT*) echo "日本" ;;
              *KIX*) echo "日本" ;;
              *)      echo "优质" ;;
            esac
          }

          # 使用 -k 忽略 SSL 证书错误，--connect-timeout 防止卡死
          # 使用 || echo "" 确保即使下载失败，脚本也能继续往下走
          SPEED_DATA=$(curl -skL --connect-timeout 10 "$API_SPEED") || echo ""
          TOP20_DATA=$(curl -skL --connect-timeout 10 "$API_TOP20") || echo ""
          YES_DATA=$(curl -skL --connect-timeout 10 "$API_YES") || echo ""

          # --- 1. ip.164746.xyz ---
          if [ ! -z "$SPEED_DATA" ]; then
            while read -r line; do
              [ -z "$line" ] && continue
              ip=$(echo $line | cut -d'#' -f1)
              full_speed=$(echo $line | cut -d'-' -f2)
              speed_num=$(echo $full_speed | grep -oE '[0-9.]+' | head -n 1)
              # 增加判断，确保 speed_num 是数字
              if [[ "$speed_num" =~ ^[0-9.]+$ ]] && [ "$(echo "$speed_num >= 60" | bc -l)" -eq 1 ]; then
                printf "A-三网优选-%s#%s\n" "$full_speed" "$ip" >> $TEMP_FILE
              fi
            done <<< "$SPEED_DATA"
          fi

          # --- 2. vps789.com ---
          if [ ! -z "$TOP20_DATA" ] && echo "$TOP20_DATA" | jq . >/dev/null 2>&1; then
            for type in "dx:电信优选-CTCC" "lt:联通优选-CUCC" "yd:移动优选-CMCC"; do
              key_p=$(echo $type | cut -d':' -f1)
              name_p=$(echo $type | cut -d':' -f2)
              echo "$TOP20_DATA" | jq -c ".data.good | sort_by(.${key_p}Score) | .[0:5] | to_entries[]" | while read -r row; do
                ip=$(echo "$row" | jq -r '.value.ip')
                index=$(echo "$row" | jq -r '.key + 1')
                printf "%s-%02d#%s\n" "$name_p" "$index" "$ip" >> $TEMP_FILE
              done
            done
          fi

          # --- 3. CloudFlareYes ---
          if [ ! -z "$YES_DATA" ]; then
            ct_cnt=6; cu_cnt=6; cm_cnt=6 
            while read -r line; do
              [ -z "$line" ] && continue
              ip=$(echo $line | cut -d'#' -f1)
              raw_tag=$(echo $line | cut -d'#' -f2)
              loc_name=$(get_loc_name "$raw_tag")
              
              if [[ "$raw_tag" == CT-* ]]; then
                printf "电信优选-CTCC-%02d-%s#%s\n" "$ct_cnt" "$loc_name" "$ip" >> $TEMP_FILE
                ((ct_cnt++))
              elif [[ "$raw_tag" == CU-* ]]; then
                printf "联通优选-CUCC-%02d-%s#%s\n" "$cu_cnt" "$loc_name" "$ip" >> $TEMP_FILE
                ((cu_cnt++))
              elif [[ "$raw_tag" == CM-* ]]; then
                printf "移动优选-CMCC-%02d-%s#%s\n" "$cm_cnt" "$loc_name" "$ip" >> $TEMP_FILE
                ((cm_cnt++))
              fi
            done <<< "$YES_DATA"
          fi

          # 生成最终文件
          echo "# 更新时间: $(date '+%Y-%m-%d %H:%M:%S')" > $TARGET_FILE
          if [ -f "$TEMP_FILE" ]; then
            sort -u $TEMP_FILE | sed 's/^A-//' | awk -F'#' '{print $2 "#" $1}' >> $TARGET_FILE
          fi

      - name: 提交并推送
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add addressesapi.txt
          if git diff --staged --quiet; then
            echo "无变动"
          else
            git commit -m "Scheduled Update: $(date '+%Y-%m-%d %H:%M')"
            git push
          fi
