name: è‡ªåŠ¨æ›´æ–°IPåˆ—è¡¨

on:
  workflow_dispatch:      # æ‰‹åŠ¨è§¦å‘æŒ‰é’®
  schedule:
    - cron: '0 */2 * * *' # æ¯2å°æ—¶è¿è¡Œä¸€æ¬¡

jobs:
  update_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # å¿…é¡»ç¡®ä¿ Settings -> Actions -> General å¼€å¯äº†å†™æƒé™
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: update_ip
        run: |
          TARGET_FILE=".github/workflows/addressesapi.txt"
          
          # ç¡®ä¿ç›®å½•å­˜åœ¨
          mkdir -p .github/workflows

          SOURCES=(
            "https://cf.090227.xyz/ip.164746.xyz|"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv4.txt|"
            "https://cf.090227.xyz/CloudFlareYes|"
            "https://cf.090227.xyz/cmcc|CMCCä¼˜åŒ–"
            "https://cf.090227.xyz/ct|CTä¼˜åŒ–"
            "https://cf.090227.xyz/cu|CUCCä¼˜åŒ–"
            "https://raw.githubusercontent.com/hubbylei/subapi/main/addressesapi.txt|"
          )

          echo "å¼€å§‹å¤„ç† IP æ•°æ®..."
          > all_ips_raw.txt

          # 1. æŠ“å– IP
          for item in "${SOURCES[@]}"; do
            url=$(echo $item | cut -d'|' -f1)
            tag=$(echo $item | cut -d'|' -f2)
            echo "æ­£åœ¨æŠ“å–: $url"
            ips=$(curl -sL --connect-timeout 10 "$url" | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?\b") || true
            for ip in $ips; do
              echo "$ip|$tag" >> all_ips_raw.txt
            done
          done

          # 2. åŽ»é‡å¹¶é™åˆ¶å‰ 100 ä¸ª
          sort -t'|' -k1,1 -u all_ips_raw.txt | head -n 100 > unique_list.txt

          # 3. å¼€å§‹æŽ¢æµ‹å¹¶å†™å…¥æ–‡ä»¶
          echo "# æ›´æ–°äºŽ $(date)" > $TARGET_FILE
          while IFS='|' read -r ip_port tag; do
            ip=$(echo $ip_port | cut -d':' -f1)
            # ä½¿ç”¨æ›´å®½å®¹çš„è¶…æ—¶è®¾ç½®
            trace_data=$(curl -s --connect-timeout 3 --max-time 5 -H "Host: speed.cloudflare.com" http://$ip/cdn-cgi/trace || echo "timeout")
            
            if [[ "$trace_data" == *"colo="* ]]; then
              colo=$(echo "$trace_data" | grep "colo=" | cut -d'=' -f2)
              loc=$(echo "$trace_data" | grep "loc=" | cut -d'=' -f2)
              
              case $loc in
                TW) flag="ðŸ‡¨ðŸ‡³ å°æ¹¾" ;;
                DE) flag="ðŸ‡©ðŸ‡ª å¾·å›½" ;;
                FR) flag="ðŸ‡«ðŸ‡· æ³•å›½" ;;
                GB) flag="ðŸ‡¬ðŸ‡§ è‹±å›½" ;;
                HK) flag="ðŸ‡­ðŸ‡° é¦™æ¸¯" ;;
                JP) flag="ðŸ‡¯ðŸ‡µ æ—¥æœ¬" ;;
                SG) flag="ðŸ‡¸ðŸ‡¬ æ–°åŠ å¡" ;;
                US) flag="ðŸ‡ºðŸ‡¸ ç¾Žå›½" ;;
                KR) flag="ðŸ‡°ðŸ‡· éŸ©å›½" ;;
                *) flag="ðŸ³ï¸ $loc" ;;
              esac
              
              remark="$flag $colo"
              [[ -n "$tag" ]] && remark="$remark - $tag"
              echo "${ip_port}#${remark}" >> $TARGET_FILE
            else
              echo "${ip_port}#æŽ¢æµ‹å¤±è´¥" >> $TARGET_FILE
            fi
          done < unique_list.txt

      - name: æäº¤ç»“æžœåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/workflows/addressesapi.txt
          
          # å…³é”®ç‚¹ï¼šæ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–ï¼Œæ²¡å˜åŒ–å°±ä¸ commitï¼Œé¿å… exit 1
          if git diff --staged --quiet; then
            echo "å†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–° IP åˆ—è¡¨: $(date)"
            git push
          fi
