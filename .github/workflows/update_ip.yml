name: è‡ªåŠ¨æ›´æ–°IPåˆ—è¡¨

on:
  workflow_dispatch:      # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 */2 * * *' # æ¯2å°æ—¶è‡ªåŠ¨è¿è¡Œä¸€æ¬¡

jobs:
  update_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write     # å¿…é¡»ç¡®ä¿ Settings é‡Œçš„ Workflow permissions å·²å¼€å¯è¯»å†™æƒé™
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: update_ip
        run: |
          TARGET_FILE=".github/workflows/addressesapi.txt"

          SOURCES=(
            "https://cf.090227.xyz/ip.164746.xyz|"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv4.txt|"
            "https://cf.090227.xyz/CloudFlareYes|"
            "https://cf.090227.xyz/cmcc|CMCCä¼˜åŒ–"
            "https://cf.090227.xyz/ct|CTä¼˜åŒ–"
            "https://cf.090227.xyz/cu|CUCCä¼˜åŒ–"
            "https://raw.githubusercontent.com/hubbylei/subapi/main/addressesapi.txt|"
          )

          echo "å¼€å§‹å¤„ç† IP æ•°æ®..."
          > all_ips_with_tags.txt

          # 1. æŠ“å– IP å¹¶æ‰“æ ‡ç­¾
          for item in "${SOURCES[@]}"; do
            url=$(echo $item | cut -d'|' -f1)
            tag=$(echo $item | cut -d'|' -f2)
            echo "æ­£åœ¨æŠ“å–: $url"
            
            ips=$(curl -sL --connect-timeout 10 "$url" | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?\b") || true
            for ip in $ips; do
              echo "$ip|$tag" >> all_ips_with_tags.txt
            done
          done

          # 2. åŽ»é‡å¹¶é™åˆ¶æ•°é‡ï¼ˆé˜²æ­¢æŽ¢æµ‹æ—¶é—´è¿‡é•¿ï¼‰
          sort -t'|' -k1,1 -u all_ips_with_tags.txt | head -n 100 > unique_list.txt

          # 3. åˆå§‹åŒ–ç»“æžœæ–‡ä»¶
          echo "# è‡ªåŠ¨ç”ŸæˆäºŽ $(date)" > $TARGET_FILE

          # 4. éåŽ†æŽ¢æµ‹æœºæˆ¿ï¼ˆå¸¦å®¹é”™å¤„ç†ï¼‰
          while IFS='|' read -r ip_port tag; do
            ip=$(echo $ip_port | cut -d':' -f1)
            echo "æ­£åœ¨æŽ¢æµ‹ $ip ..."
            
            # ä½¿ç”¨ || echo "timeout" é˜²æ­¢ exit code 28 å¯¼è‡´è„šæœ¬å´©æºƒ
            trace_data=$(curl -s --connect-timeout 3 --max-time 5 -H "Host: speed.cloudflare.com" http://$ip/cdn-cgi/trace || echo "timeout")

            if [[ "$trace_data" != "timeout" && "$trace_data" == *"colo="* ]]; then
              colo=$(echo "$trace_data" | grep "colo=" | cut -d'=' -f2)
              loc=$(echo "$trace_data" | grep "loc=" | cut -d'=' -f2)

              case $loc in
                TW) flag="ðŸ‡¨ðŸ‡³ å°æ¹¾" ;;
                DE) flag="ðŸ‡©ðŸ‡ª å¾·å›½" ;;
                FR) flag="ðŸ‡«ðŸ‡· æ³•å›½" ;;
                GB) flag="ðŸ‡¬ðŸ‡§ è‹±å›½" ;;
                HK) flag="ðŸ‡­ðŸ‡° é¦™æ¸¯" ;;
                JP) flag="ðŸ‡¯ðŸ‡µ æ—¥æœ¬" ;;
                SG) flag="ðŸ‡¸ðŸ‡¬ æ–°åŠ å¡" ;;
                US) flag="ðŸ‡ºðŸ‡¸ ç¾Žå›½" ;;
                KR) flag="ðŸ‡°ðŸ‡· éŸ©å›½" ;;
                *) flag="ðŸ³ï¸ $loc" ;;
              esac

              remark="$flag $colo"
              [ -n "$tag" ] && remark="$remark - $tag"
              echo "${ip_port}#${remark}" >> $TARGET_FILE
            else
              echo "${ip_port}#è¿žæŽ¥è¶…æ—¶/æ— æ•ˆIP" >> $TARGET_FILE
            fi
          done < unique_list.txt

      - name: æäº¤ç»“æžœåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add .github/workflows/addressesapi.txt
          git commit -m "è‡ªåŠ¨æ›´æ–° IP åˆ—è¡¨: $(date)" || exit 0
          git push
