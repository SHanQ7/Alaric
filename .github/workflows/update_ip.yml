name: è‡ªåŠ¨åŒæ­¥ä¼˜é€‰ IP

on:
  workflow_dispatch:
  schedule:
    - cron: '5 * * * *'

jobs:
  update_ip:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… jq
        run: sudo apt-get install -y jq

      - name: æå–å¹¶èšåˆæ•°æ®
        run: |
          TARGET_FILE="addressesapi.txt"
          API_LINE="https://vps789.com/openApi/cfIpApi"
          API_TOP20="https://vps789.com/openApi/cfIpTop20"
          API_YES="https://cf.090227.xyz/CloudFlareYes"
          
          # èŽ·å–æ•°æ®
          LINE_DATA=$(curl -sL "$API_LINE")
          TOP20_DATA=$(curl -sL "$API_TOP20")
          YES_DATA=$(curl -sL "$API_YES")

          # åˆå§‹åŒ–æ–‡ä»¶
          echo "# æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')" > $TARGET_FILE
          echo "" >> $TARGET_FILE

          # å®šä¹‰ä½ç½®è½¬æ¢å‡½æ•°
          get_loc() {
            case "$1" in
              *HKG*) echo "ðŸ‡­ðŸ‡° é¦™æ¸¯" ;;
              *SJC*) echo "ðŸ‡ºðŸ‡¸ ç¾Žå›½" ;;
              *SEA*) echo "ðŸ‡ºðŸ‡¸ ç¾Žå›½" ;;
              *SIN*) echo "ðŸ‡¸ðŸ‡¬ æ–°åŠ å¡" ;;
              *LAX*) echo "ðŸ‡ºðŸ‡¸ ç¾Žå›½" ;;
              *JP*)  echo "ðŸ‡¯ðŸ‡µ æ—¥æœ¬" ;;
              *)     echo "ðŸ³ï¸ å…¶å®ƒ" ;;
            esac
          }

          # --- 1. ç”µä¿¡ (CTCC) ---
          echo "$LINE_DATA" | jq -r '.data.CT | sort_by(.dxScore) | .[0:3] | to_entries[] | "\(.value.ip)#CTCC - ç”µä¿¡ä¼˜åŒ–çº¿è·¯ - 0\(.key + 1)"' >> $TARGET_FILE
          echo "$TOP20_DATA" | jq -r '.data.good | sort_by(.dxLatency) | .[0:2] | to_entries[] | "\(.value.ip)#CTCC - ç”µä¿¡ä¼˜åŒ–çº¿è·¯ - 0\(.key + 4)"' >> $TARGET_FILE
          # ä»Ž CloudFlareYes æå– CT èŠ‚ç‚¹
          count=6
          while read -r line && [ $count -le 10 ]; do
            ip=$(echo $line | cut -d'#' -f1)
            raw_tag=$(echo $line | cut -d'#' -f2)
            loc=$(get_loc "$raw_tag")
            echo "$ip#$loc - CTCCç”µä¿¡ä¼˜åŒ–çº¿è·¯ - 0$count" >> $TARGET_FILE
            ((count++))
          done <<< "$(echo "$YES_DATA" | grep "CT-")"

          # --- 2. ç§»åŠ¨ (CMCC) ---
          echo "$LINE_DATA" | jq -r '.data.CM | sort_by(.ydScore) | .[0:3] | to_entries[] | "\(.value.ip)#CMCC - ç§»åŠ¨ä¼˜åŒ–çº¿è·¯ - 0\(.key + 1)"' >> $TARGET_FILE
          echo "$TOP20_DATA" | jq -r '.data.good | sort_by(.ydLatency) | .[0:2] | to_entries[] | "\(.value.ip)#CMCC - ç§»åŠ¨ä¼˜åŒ–çº¿è·¯ - 0\(.key + 4)"' >> $TARGET_FILE
          # ä»Ž CloudFlareYes æå– CM èŠ‚ç‚¹
          count=6
          while read -r line && [ $count -le 10 ]; do
            ip=$(echo $line | cut -d'#' -f1)
            raw_tag=$(echo $line | cut -d'#' -f2)
            loc=$(get_loc "$raw_tag")
            echo "$ip#$loc - CMCCç§»åŠ¨ä¼˜åŒ–çº¿è·¯ - 0$count" >> $TARGET_FILE
            ((count++))
          done <<< "$(echo "$YES_DATA" | grep "CM-")"

          # --- 3. è”é€š (CUCC) ---
          echo "$LINE_DATA" | jq -r '.data.CU | sort_by(.ltScore) | .[0:3] | to_entries[] | "\(.value.ip)#CUCC - è”é€šä¼˜åŒ–çº¿è·¯ - 0\(.key + 1)"' >> $TARGET_FILE
          echo "$TOP20_DATA" | jq -r '.data.good | sort_by(.ltLatency) | .[0:2] | to_entries[] | "\(.value.ip)#CUCC - è”é€šä¼˜åŒ–çº¿è·¯ - 0\(.key + 4)"' >> $TARGET_FILE
          # ä»Ž CloudFlareYes æå– CU èŠ‚ç‚¹
          count=6
          while read -r line && [ $count -le 10 ]; do
            ip=$(echo $line | cut -d'#' -f1)
            raw_tag=$(echo $line | cut -d'#' -f2)
            loc=$(get_loc "$raw_tag")
            echo "$ip#$loc - CUCCè”é€šä¼˜åŒ–çº¿è·¯ - 0$count" >> $TARGET_FILE
            ((count++))
          done <<< "$(echo "$YES_DATA" | grep "CU-")"

      - name: æäº¤å¹¶æŽ¨é€
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add addressesapi.txt
          if git diff --staged --quiet; then
            echo "æ•°æ®æœªå˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°ä¼˜é€‰IP: $(date '+%Y-%m-%d %H:%M')"
            git push
          fi
