name: è‡ªåŠ¨æ›´æ–°IPåˆ—è¡¨

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */2 * * *' 

jobs:
  update_job:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: update_ip
        run: |
          TARGET_FILE="addressesapi.txt"

          SOURCES=(
            "https://cf.090227.xyz/ip.164746.xyz|"
            "https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/BestCF/bestcfv4.txt|"
            "https://cf.090227.xyz/CloudFlareYes|"
            "https://cf.090227.xyz/cmcc|CMCCä¼˜åŒ–"
            "https://cf.090227.xyz/ct|CTCCä¼˜åŒ–"
            "https://cf.090227.xyz/cu|CUCCä¼˜åŒ–"
            "https://raw.githubusercontent.com/hubbylei/subapi/main/addressesapi.txt|"
          )

          echo "å¼€å§‹æŠ“å–æ•°æ®..."
          > all_ips_raw.txt
          for item in "${SOURCES[@]}"; do
            url=$(echo $item | cut -d'|' -f1)
            tag=$(echo $item | cut -d'|' -f2)
            ips=$(curl -sL --connect-timeout 10 "$url" | grep -oE "\b([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?\b") || true
            for ip in $ips; do
              echo "$ip|$tag" >> all_ips_raw.txt
            done
          done

          sort -t'|' -k1,1 -u all_ips_raw.txt | head -n 100 > unique_list.txt

          echo "# æ›´æ–°æ—¶é—´: $(date)" > $TARGET_FILE
          
          echo "å¼€å§‹æŽ¢æµ‹èŠ‚ç‚¹..."
          while IFS='|' read -r ip_port tag; do
            ip=$(echo $ip_port | cut -d':' -f1)
            trace_data=$(curl -s --connect-timeout 3 --max-time 5 -H "Host: speed.cloudflare.com" http://$ip/cdn-cgi/trace || echo "timeout")
            
            if [[ "$trace_data" == *"colo="* ]]; then
              colo_raw=$(echo "$trace_data" | grep "colo=" | cut -d'=' -f2)
              colo=$(echo "$colo_raw" | tr '[:lower:]' '[:upper:]')
              
              loc=$(echo "$trace_data" | grep "loc=" | cut -d'=' -f2)
              case $loc in
                TW) flag="ðŸ‡¨ðŸ‡³ å°æ¹¾" ;; HK) flag="ðŸ‡­ðŸ‡° é¦™æ¸¯" ;; SG) flag="ðŸ‡¸ðŸ‡¬ æ–°åŠ å¡" ;;
                JP) flag="ðŸ‡¯ðŸ‡µ æ—¥æœ¬" ;; US) flag="ðŸ‡ºðŸ‡¸ ç¾Žå›½" ;; KR) flag="ðŸ‡°ðŸ‡· éŸ©å›½" ;;
                DE) flag="ðŸ‡©ðŸ‡ª å¾·å›½" ;; FR) flag="ðŸ‡«ðŸ‡· æ³•å›½" ;; GB) flag="ðŸ‡¬ðŸ‡§ è‹±å›½" ;;
                CN) flag="ðŸ‡¨ðŸ‡³ ä¸­å›½" ;;
                *) flag="ðŸ³ï¸ $loc" ;;
              esac
              
              remark="$flag $colo"
              [[ -n "$tag" ]] && remark="$remark - $tag"
              
              echo "${ip_port}#${remark}" >> $TARGET_FILE
            else
              echo "è·³è¿‡å¤±æ•ˆèŠ‚ç‚¹: $ip"
            fi
          done < unique_list.txt

      - name: æäº¤ç»“æžœåˆ°ä»“åº“
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # ã€ä¼˜åŒ–ã€‘æ·»åŠ æ ¹ç›®å½•ä¸‹çš„æ–‡ä»¶
          git add addressesapi.txt
          
          if git diff --staged --quiet; then
            echo "æ•°æ®æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–° IP åˆ—è¡¨: $(date)"
            git push
          fi
