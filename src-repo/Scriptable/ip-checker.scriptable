// IPPure é£é™©ç›‘æµ‹ - ç»ç’ƒæ‹Ÿæ€ç¾åŒ–ç‰ˆ
const url = "https://my.ippure.com/v1/info";

async function fetchData() {
  try {
    let req = new Request(url);
    req.timeoutInterval = 8;
    return await req.loadJSON();
  } catch (e) { return null; }
}

const data = await fetchData();
let widget = await createWidget(data);

if (!config.runsInWidget) {
  await widget.presentMedium();
}
Script.setWidget(widget);
Script.complete();

async function createWidget(data) {
  let w = new ListWidget();
  w.setPadding(8, 12, 8, 12);

  // --- é«˜çº§è‰²å½©å®šä¹‰ ---
  const isDark = Device.isUsingDarkAppearance();
  const bgColor = Color.dynamic(new Color("#FFFFFF"), new Color("#0A0A0C"));
  const mainTextColor = Color.dynamic(new Color("#1C1C1E"), new Color("#FFFFFF"));
  const squareColor = new Color("#8165AC"); // ä¸“å±ç´«
  const subBgColor = Color.dynamic(new Color("#F2F2F7"), new Color("#1C1C1E"));
  
  // èƒŒæ™¯æ¸å˜
  let startColor = isDark ? new Color("#161618") : new Color("#FFFFFF");
  let endColor = isDark ? new Color("#0A0A0C") : new Color("#F9F9FB");
  let gradient = new LinearGradient();
  gradient.colors = [startColor, endColor];
  gradient.locations = [0, 1];
  w.backgroundGradient = gradient;

  if (!data) {
    let msg = w.addText("âš ï¸ è¿æ¥ä¸­...");
    msg.textColor = mainTextColor;
    msg.centerAlignText();
    return w;
  }

  const score = data.fraudScore || 0;
  const risk = getRiskLevel(score);
  const flag = getFlagEmoji(data.countryCode);

  let mainStack = w.addStack();
  mainStack.centerAlignContent();

  // --- å·¦ä¾§ä¿¡æ¯æ€»æ  ---
  let leftStack = mainStack.addStack();
  leftStack.layoutVertically();
  
  const addStyledInfo = (shortLabel, fullValue) => {
    let rowStack = leftStack.addStack();
    rowStack.centerAlignContent();
    
    // 1. å·¦ä¾§æ ‡ç­¾æ–¹æ¡† (å¸¦èƒŒæ™¯å¡«å……)
    let labelStack = rowStack.addStack();
    labelStack.size = new Size(26, 22); 
    labelStack.centerAlignContent();

    let boxStack = labelStack.addStack();
    boxStack.size = new Size(18, 18); 
    boxStack.cornerRadius = 5;
    boxStack.borderWidth = 1.5; 
    boxStack.borderColor = squareColor;
    boxStack.backgroundColor = new Color(squareColor.hex, 0.1); // 10% é€æ˜å¡«å……
    boxStack.centerAlignContent();
    
    let lText = boxStack.addText(shortLabel);
    lText.font = Font.boldSystemFont(9);
    lText.textColor = squareColor;
    
    rowStack.addSpacer(4); 

    // 2. å³ä¾§ä¿¡æ¯æ¤­åœ†å®¹å™¨ (å®½åº¦ä¼˜åŒ–ä¸º 135)
    let infoValueStack = rowStack.addStack();
    infoValueStack.size = new Size(135, 20); 
    infoValueStack.cornerRadius = 10; 
    infoValueStack.borderWidth = 2; 
    infoValueStack.borderColor = squareColor;
    infoValueStack.backgroundColor = Color.dynamic(new Color("#FFFFFF", 0.5), new Color("#FFFFFF", 0.05));
    infoValueStack.setPadding(0, 8, 0, 8);
    infoValueStack.centerAlignContent();

    let vText = infoValueStack.addText(fullValue);
    vText.font = Font.boldSystemFont(10);
    vText.textColor = mainTextColor;
    vText.lineLimit = 1;
    vText.minimumScaleFactor = 0.7;
    
    leftStack.addSpacer(3); 
  };

  // æŒ‰ç…§ä½ çš„è¦æ±‚æ›´æ–°æ ‡ç­¾å†…å®¹
  addStyledInfo("ä½", `${flag} ${data.countryCode || 'UN'} Â· ${data.city || 'Unknown'}`);
  addStyledInfo("å€", data.ip || "N/A");
  addStyledInfo("æœ", data.asOrganization || "N/A");
  addStyledInfo("ç¼–", data.asn ? `AS${data.asn}` : "N/A");
  addStyledInfo("å‹", data.isResidential ? "ä½å®…ç½‘ç»œ" : "æœºæˆ¿ç½‘ç»œ");
  
  leftStack.addSpacer(2);
  let time = leftStack.addText(`Last Scan: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
  time.font = Font.mediumSystemFont(8);
  time.textColor = squareColor;
  time.textOpacity = 0.5;

  mainStack.addSpacer();

  // --- å³ä¾§åœ†ç¯æ  (å¢åŠ é˜´å½±ä¸å‘å…‰æ„Ÿ) ---
  let rightStack = mainStack.addStack();
  let ringStack = rightStack.addStack();
  ringStack.size = new Size(92, 92);
  ringStack.centerAlignContent();

  let canvas = new DrawContext();
  const cSize = 200;
  canvas.size = new Size(cSize, cSize);
  canvas.opaque = false;
  
  // ç»˜åˆ¶åº•éƒ¨å‘å…‰ç¯
  canvas.setLineWidth(12);
  canvas.setStrokeColor(new Color(risk.color.hex, 0.2));
  canvas.strokeEllipse(new Rect(10, 10, cSize-20, cSize-20));
  
  // ç»˜åˆ¶ä¸»è¿›åº¦ç‚¹ (å¸¦å‘å…‰)
  canvas.setStrokeColor(risk.color);
  const deg = (score / 100) * 360;
  for (let i = 0; i <= deg; i += 2.5) {
    let x = cSize/2 + (cSize/2-10) * Math.cos((i-90) * Math.PI/180);
    let y = cSize/2 + (cSize/2-10) * Math.sin((i-90) * Math.PI/180);
    canvas.fillEllipse(new Rect(x-8, y-8, 16, 16));
  }
  
  ringStack.backgroundImage = canvas.getImage();
  
  let centerColumn = ringStack.addStack();
  centerColumn.layoutVertically();
  
  let scoreText = centerColumn.addText(`${score}`);
  scoreText.font = Font.boldSystemFont(26);
  scoreText.textColor = mainTextColor;
  scoreText.centerAlignText();
  
  let riskText = centerColumn.addText(risk.text);
  riskText.font = Font.boldSystemFont(10);
  riskText.textColor = risk.color;
  riskText.centerAlignText();

  return w;
}

function getRiskLevel(score) {
  if (score <= 25) return { text: "SAFE", color: new Color("#34C759") };
  if (score <= 50) return { text: "WARN", color: new Color("#FFCC00") };
  if (score <= 75) return { text: "RISK", color: new Color("#FF9500") };
  return { text: "DANGER", color: new Color("#FF3B30") };
}

function getFlagEmoji(countryCode) {
  if (!countryCode) return "ğŸŒ";
  return countryCode.toUpperCase().replace(/./g, char => 
    String.fromCodePoint(127397 + char.charCodeAt())
  );
}
