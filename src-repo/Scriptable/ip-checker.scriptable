// IPPure é£é™©ç›‘æµ‹ - æç®€ä¸­å¿ƒæ•°å­—ç‰ˆ
const url = "https://my.ippure.com/v1/info";

async function fetchData() {
    try {
        let req = new Request(url);
        req.timeoutInterval = 8;
        return await req.loadJSON();
    } catch (e) { return null; }
}

const data = await fetchData();
let widget = await createWidget(data);

if (!config.runsInWidget) {
    await widget.presentMedium();
}
Script.setWidget(widget);
Script.complete();

async function createWidget(data) {
    let w = new ListWidget();
    w.setPadding(0, 16, 0, 16); // å‡å°å‚ç›´è¾¹è·
    w.backgroundColor = new Color("#000000");

    if (!data) {
        let msg = w.addText("âš ï¸ æ•°æ®è¿æ¥å¤±è´¥");
        msg.textColor = Color.white();
        msg.centerAlignText();
        return w;
    }

    const score = data.fraudScore || 0;
    const risk = getRiskLevel(score);
    const flag = getFlagEmoji(data.countryCode);

    // ä¸»å¸ƒå±€
    let mainStack = w.addStack();
    mainStack.centerAlignContent();

    // --- å·¦ä¾§ä¿¡æ¯æ  ---
    let leftStack = mainStack.addStack();
    leftStack.layoutVertically();
    
    const addInfo = (label, value) => {
        let s = leftStack.addStack();
        let lText = s.addText(label + ": ");
        lText.font = Font.systemFont(12);
        lText.textColor = new Color("#888888");
        let vText = s.addText(value);
        vText.font = Font.mediumSystemFont(12);
        vText.textColor = Color.white();
        vText.lineLimit = 1;
        vText.minimumScaleFactor = 0.8;
        leftStack.addSpacer(5);
    };

    addInfo("èŠ‚ç‚¹", `${flag} ${data.countryCode || 'UN'}`);
    addInfo("åœ°å€", data.ip || "N/A");
    addInfo("å®½å¸¦", data.asOrganization || "N/A");
    addInfo("ç±»å‹", data.isResidential ? "ä½å®…ç½‘ç»œ" : "æ•°æ®ä¸­å¿ƒ");
    
    leftStack.addSpacer(4);
    let time = leftStack.addText(`æ›´æ–°äº ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
    time.font = Font.systemFont(9);
    time.textColor = new Color("#444444");

    mainStack.addSpacer();

    // --- å³ä¾§åœ†ç¯æ  (ä½¿ç”¨å åŠ å¸ƒå±€å®ç°æ•°å­—å±…ä¸­) ---
    let rightStack = mainStack.addStack();
    // ä½¿ç”¨ç»˜å›¾å±‚ä½œä¸ºèƒŒæ™¯
    let ringStack = rightStack.addStack();
    ringStack.size = new Size(100, 100);
    ringStack.centerAlignContent();

    // ç»˜åˆ¶åœ†ç¯
    let canvas = new DrawContext();
    const size = 200;
    canvas.size = new Size(size, size);
    canvas.opaque = false;
    canvas.setLineWidth(16);
    // åº•è‰²ç¯
    canvas.setStrokeColor(new Color("#222222"));
    canvas.strokeEllipse(new Rect(10, 10, size-20, size-20));
    // è¿›åº¦ç¯
    canvas.setStrokeColor(risk.color);
    const deg = (score / 100) * 360;
    for (let i = 0; i <= deg; i += 2.5) {
        let x = size/2 + (size/2-10) * Math.cos((i-90) * Math.PI/180);
        let y = size/2 + (size/2-10) * Math.sin((i-90) * Math.PI/180);
        canvas.fillEllipse(new Rect(x-9, y-9, 18, 18));
    }
    
    // å°†åœ†ç¯è®¾ä¸ºèƒŒæ™¯å›¾ï¼Œå¹¶å åŠ æ–‡å­—
    ringStack.backgroundImage = canvas.getImage();
    
    let centerColumn = ringStack.addStack();
    centerColumn.layoutVertically();
    
    let scoreText = centerColumn.addText(`${score}`);
    scoreText.font = Font.boldSystemFont(26);
    scoreText.textColor = Color.white();
    scoreText.centerAlignText();
    
    let riskText = centerColumn.addText(risk.text);
    riskText.font = Font.boldSystemFont(11);
    riskText.textColor = risk.color;
    riskText.centerAlignText();

    return w;
}

function getRiskLevel(score) {
    // è°ƒæ•´é¢œè‰²ï¼šä½¿ç”¨æ›´é²œè‰³çš„ iOS ç³»ç»Ÿè‰²
    if (score <= 25) return { text: "å®‰å…¨", color: new Color("#34C759") };
    if (score <= 50) return { text: "ä¸­ç­‰", color: new Color("#FFCC00") };
    if (score <= 75) return { text: "é«˜å±", color: new Color("#FF9500") };
    return { text: "æé«˜", color: new Color("#FF3B30") };
}

function getFlagEmoji(countryCode) {
    if (!countryCode) return "ğŸŒ";
    return countryCode.toUpperCase().replace(/./g, char => 
        String.fromCodePoint(127397 + char.charCodeAt())
    );
}
