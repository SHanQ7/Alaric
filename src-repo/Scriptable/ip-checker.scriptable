// IPPure é£é™©ç›‘æµ‹ (æç®€åœ†ç¯ç‰ˆ)
const url = "https://my.ippure.com/v1/info";

async function fetchData() {
    try {
        let req = new Request(url);
        req.timeoutInterval = 8;
        let data = await req.loadJSON();
        return data;
    } catch (e) { return null; }
}

const data = await fetchData();
let widget = await createWidget(data);

if (!config.runsInWidget) {
    await widget.presentMedium();
}
Script.setWidget(widget);
Script.complete();

async function createWidget(data) {
    let w = new ListWidget();
    w.setPadding(12, 16, 12, 16);
    
    // èƒŒæ™¯ï¼šå…¨é»‘æ›´æ˜¾é«˜çº§
    w.backgroundColor = new Color("#000000");

    if (!data) {
        let msg = w.addText("âš ï¸ æ•°æ®è·å–å¤±è´¥");
        msg.textColor = Color.white();
        msg.centerAlignText();
        return w;
    }

    const score = data.fraudScore || 0;
    const risk = getRiskLevel(score);
    const flag = getFlagEmoji(data.countryCode);

    // ä¸»å¸ƒå±€
    let mainStack = w.addStack();
    mainStack.centerAlignContent();

    // --- å·¦ä¾§ä¿¡æ¯åˆ— ---
    let leftStack = mainStack.addStack();
    leftStack.layoutVertically();
    
    const addInfo = (label, value) => {
        let s = leftStack.addStack();
        let lText = s.addText(label + "  ");
        lText.font = Font.systemFont(12);
        lText.textColor = new Color("#888888");
        
        let vText = s.addText(value);
        vText.font = Font.mediumSystemFont(12);
        vText.textColor = Color.white();
        vText.lineLimit = 1;
        vText.minimumScaleFactor = 0.8;
        leftStack.addSpacer(5);
    };

    addInfo("èŠ‚ç‚¹", `${flag} ${data.countryCode || 'Unknown'}`);
    addInfo("åœ°å€", data.ip || "N/A");
    addInfo("å®½å¸¦", data.asOrganization || "N/A");
    addInfo("ç±»å‹", data.isResidential ? "ä½å®…ç½‘ç»œ" : "æ•°æ®ä¸­å¿ƒ");
    
    leftStack.addSpacer(6);
    let time = leftStack.addText(`Last update: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
    time.font = Font.systemFont(9);
    time.textColor = new Color("#444444");

    mainStack.addSpacer(); // æ’‘å¼€å·¦å³

    // --- å³ä¾§åœ†ç¯åˆ— ---
    let rightStack = mainStack.addStack();
    rightStack.layoutVertically();
    rightStack.centerAlignContent();

    // ç»˜å›¾åŒºåŸŸ
    let canvas = new DrawContext();
    const size = 200;
    canvas.size = new Size(size, size);
    canvas.opaque = false;
    canvas.respectScreenScale = true;

    // 1. ç»˜åˆ¶åº•ç¯
    canvas.setLineWidth(16);
    canvas.setStrokeColor(new Color("#222222"));
    canvas.strokeEllipse(new Rect(10, 10, size-20, size-20));

    // 2. ç»˜åˆ¶è¿›åº¦ç¯ (ç‚¹çŠ¶æ¨¡æ‹Ÿ)
    canvas.setStrokeColor(risk.color);
    const deg = (score / 100) * 360;
    for (let i = 0; i <= deg; i += 3) {
        let x = size/2 + (size/2-10) * Math.cos((i-90) * Math.PI/180);
        let y = size/2 + (size/2-10) * Math.sin((i-90) * Math.PI/180);
        canvas.fillEllipse(new Rect(x-8, y-8, 16, 16));
    }

    // 3. åœ¨åœ†ç¯ä¸­å¿ƒç»˜åˆ¶åˆ†æ•°
    canvas.setTextColor(Color.white());
    canvas.setFont(Font.boldSystemFont(48));
    const scoreStr = `${score}`;
    // ç®€å•çš„å±…ä¸­ç®—æ³•
    const rect = new Rect(0, size/2 - 30, size, 60);
    canvas.drawTextInRect(scoreStr, rect);

    let ringImage = rightStack.addImage(canvas.getImage());
    ringImage.imageSize = new Size(90, 90);
    
    rightStack.addSpacer(6);
    let riskLabel = rightStack.addText(risk.text);
    riskLabel.font = Font.boldSystemFont(13);
    riskLabel.textColor = risk.color;
    riskLabel.centerAlignText();

    return w;
}

function getRiskLevel(score) {
    if (score <= 25) return { text: "å®‰å…¨", color: new Color("#34c759") };
    if (score <= 50) return { text: "ä¸­ç­‰", color: new Color("#ffcc00") };
    if (score <= 75) return { text: "å±é™©", color: new Color("#ff9500") };
    return { text: "æé«˜é£é™©", color: new Color("#ff3b30") };
}

function getFlagEmoji(countryCode) {
    if (!countryCode) return "ğŸ³ï¸";
    return countryCode.toUpperCase().replace(/./g, char => 
        String.fromCodePoint(127397 + char.charCodeAt())
    );
}
