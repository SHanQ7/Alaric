// IPPure é£é™©ç›‘æµ‹ - å¡ç‰‡æ ‡ç­¾ç¾åŒ–ç‰ˆ
const url = "https://my.ippure.com/v1/info";

async function fetchData() {
  try {
    let req = new Request(url);
    req.timeoutInterval = 8;
    return await req.loadJSON();
  } catch (e) { return null; }
}

const data = await fetchData();
let widget = await createWidget(data);

if (!config.runsInWidget) {
  await widget.presentMedium();
}
Script.setWidget(widget);
Script.complete();

async function createWidget(data) {
  let w = new ListWidget();
  w.setPadding(10, 16, 10, 16);

  // åŠ¨æ€é¢œè‰²é…ç½®
  const bgColor = Color.dynamic(new Color("#FFFFFF"), new Color("#1C1C1E"));
  const mainTextColor = Color.dynamic(new Color("#000000"), new Color("#FFFFFF"));
  // æ ‡ç­¾æ¡†çš„èƒŒæ™¯è‰²ï¼šç™½å¤©æµ…ç´«/ç°ï¼Œå¤œé—´æ·±ç´«/ç°
  const tagBgColor = Color.dynamic(new Color("#F2F2F7"), new Color("#2C2C2E"));
  const tagTextColor = Color.dynamic(new Color("#5856D6"), new Color("#9897EF")); // ç´«è‰²ç³»ï¼Œå‘¼åº”æ‚¨çš„å›¾ç‰‡

  w.backgroundColor = bgColor;

  if (!data) {
    let msg = w.addText("âš ï¸ æ•°æ®è¿æ¥å¤±è´¥");
    msg.textColor = mainTextColor;
    msg.centerAlignText();
    return w;
  }

  const score = data.fraudScore || 0;
  const risk = getRiskLevel(score);
  const flag = getFlagEmoji(data.countryCode);

  let mainStack = w.addStack();
  mainStack.centerAlignContent();

  // --- å·¦ä¾§ä¿¡æ¯æ  ---
  let leftStack = mainStack.addStack();
  leftStack.layoutVertically();
  
  // æ ¸å¿ƒï¼šåˆ›å»ºåƒå›¾ç‰‡ä¸€æ ·çš„å¡ç‰‡æ ‡ç­¾æ ·å¼
  const addInfo = (label, value) => {
    let rowStack = leftStack.addStack();
    rowStack.centerAlignContent();
    
    // æ ‡ç­¾å®¹å™¨ï¼ˆæ¡†æ¡†ï¼‰
    let labelBox = rowStack.addStack();
    labelBox.backgroundColor = tagBgColor;
    labelBox.cornerRadius = 4; // åœ†è§’
    labelBox.setPadding(2, 4, 2, 4); // æ¡†å†…è¾¹è·
    
    let lText = labelBox.addText(label);
    lText.font = Font.boldSystemFont(10);
    lText.textColor = tagTextColor;
    
    rowStack.addSpacer(6); // æ¡†ä¸æ–‡å­—çš„é—´è·
    
    let vText = rowStack.addText(value);
    vText.font = Font.mediumSystemFont(11);
    vText.textColor = mainTextColor;
    vText.lineLimit = 1;
    vText.minimumScaleFactor = 0.8;
    
    leftStack.addSpacer(5);
  };

  addInfo("å‡ºå£ä½ç½®", `${flag} ${data.countryCode || 'UN'} Â· ${data.city || ''}`);
  addInfo("IPåœ°å€", data.ip || "N/A");
  addInfo("è¿è¥å•†", data.asOrganization || "N/A");
  addInfo("ASNç¼–å·", data.asn ? `AS${data.asn}` : "N/A");
  addInfo("ç½‘ç»œç±»å‹", data.isResidential ? "ä½å®…ç½‘ç»œ" : "æ•°æ®ä¸­å¿ƒ");
  
  leftStack.addSpacer(2);
  let time = leftStack.addText(`Updated: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
  time.font = Font.systemFont(8);
  time.textColor = Color.dynamic(new Color("#CCCCCC"), new Color("#444444"));

  mainStack.addSpacer();

  // --- å³ä¾§åœ†ç¯æ  ---
  let rightStack = mainStack.addStack();
  let ringStack = rightStack.addStack();
  ringStack.size = new Size(100, 100);
  ringStack.centerAlignContent();

  let canvas = new DrawContext();
  const size = 200;
  canvas.size = new Size(size, size);
  canvas.opaque = false;
  
  canvas.setLineWidth(16);
  canvas.setStrokeColor(Color.dynamic(new Color("#E5E5EA"), new Color("#2C2C2E")));
  canvas.strokeEllipse(new Rect(10, 10, size-20, size-20));
  
  canvas.setStrokeColor(risk.color);
  const deg = (score / 100) * 360;
  for (let i = 0; i <= deg; i += 2.5) {
    let x = size/2 + (size/2-10) * Math.cos((i-90) * Math.PI/180);
    let y = size/2 + (size/2-10) * Math.sin((i-90) * Math.PI/180);
    canvas.fillEllipse(new Rect(x-9, y-9, 18, 18));
  }
  
  ringStack.backgroundImage = canvas.getImage();
  
  let centerColumn = ringStack.addStack();
  centerColumn.layoutVertically();
  
  let scoreText = centerColumn.addText(`${score}`);
  scoreText.font = Font.boldSystemFont(28);
  scoreText.textColor = mainTextColor;
  scoreText.centerAlignText();
  
  let riskText = centerColumn.addText(risk.text);
  riskText.font = Font.boldSystemFont(11);
  riskText.textColor = risk.color;
  riskText.centerAlignText();

  return w;
}

function getRiskLevel(score) {
  if (score <= 25) return { text: "å®‰å…¨", color: new Color("#34C759") };
  if (score <= 50) return { text: "ä¸­ç­‰", color: new Color("#FFCC00") };
  if (score <= 75) return { text: "é«˜å±", color: new Color("#FF9500") };
  return { text: "æé«˜", color: new Color("#FF3B30") };
}

function getFlagEmoji(countryCode) {
  if (!countryCode) return "ğŸŒ";
  return countryCode.toUpperCase().replace(/./g, char => 
    String.fromCodePoint(127397 + char.charCodeAt())
  );
}
