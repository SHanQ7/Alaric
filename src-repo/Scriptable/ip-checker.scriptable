// IPPure å½“å‰ç½‘ç»œç¯å¢ƒæ£€æŸ¥è„šæœ¬
const url = "https://my.ippure.com/v1/info";

async function fetchData() {
    try {
        let req = new Request(url);
        req.timeoutInterval = 10;
        req.headers = {
            "User-Agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 16_0 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.0 Mobile/15E148 Safari/604.1"
        };
        let data = await req.loadJSON();
        return data;
    } catch (e) {
        return null;
    }
}

// ä¸»é€»è¾‘
const data = await fetchData();
let widget = await createWidget(data);

if (!config.runsInWidget) {
    await widget.presentMedium(); // é¢„è§ˆä¸­å·ç»„ä»¶
}

Script.setWidget(widget);
Script.complete();

async function createWidget(data) {
    let w = new ListWidget();
    // è®¾ç½®æ¸å˜èƒŒæ™¯ï¼Œæ›´ç°ä»£æ„Ÿ
    let gradient = new LinearGradient();
    gradient.colors = [new Color("#1a1a1a"), new Color("#2c3e50")];
    gradient.locations = [0, 1];
    w.backgroundGradient = gradient;

    if (!data) {
        let errorTxt = w.addText("âš ï¸ æ— æ³•è·å–æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        errorTxt.textColor = Color.white();
        errorTxt.centerAlignText();
        return w;
    }

    // å¤´éƒ¨ï¼šæ ‡é¢˜ä¸å›½æ——
    let headerStack = w.addStack();
    headerStack.centerAlignContent();
    let flag = getFlagEmoji(data.countryCode);
    let title = headerStack.addText(`${flag} IPPure èŠ‚ç‚¹è¯¦æƒ…`);
    title.font = Font.boldSystemFont(16);
    title.textColor = Color.white();
    
    w.addSpacer(10);

    // ä¿¡æ¯å±•ç¤ºå‡½æ•°
    const addRow = (label, value, valueColor) => {
        let rowStack = w.addStack();
        let labelText = rowStack.addText(label + ": ");
        labelText.font = Font.systemFont(13);
        labelText.textColor = new Color("#cccccc");
        
        let valueText = rowStack.addText(value);
        valueText.font = Font.mediumSystemFont(13);
        valueText.textColor = valueColor || Color.white();
        w.addSpacer(4);
    };

    const risk = getRiskLevel(data.fraudScore || 0);

    // å¡«å……æ•°æ®
    addRow("IP åœ°å€", data.ip || "N/A");
    addRow("è¿è¥å•†", data.asOrganization || "N/A");
    addRow("åœ°ç†ä½ç½®", `${data.region || ''} - ${data.city || ''}`);
    addRow("ç½‘ç»œç±»å‹", data.isResidential ? "ğŸ  ä½å®…ç½‘ç»œ" : "ğŸ¢ æ•°æ®ä¸­å¿ƒ");
    addRow("æ¬ºè¯ˆåˆ†", `${data.fraudScore || 0} åˆ†`, risk.color);
    addRow("é£é™©ç­‰çº§", risk.text, risk.color);

    w.addSpacer();
    
    // åº•éƒ¨æ›´æ–°æ—¶é—´
    let footer = w.addText(`æ›´æ–°äº ${new Date().toLocaleTimeString()}`);
    footer.font = Font.systemFont(10);
    footer.textColor = new Color("#888888");
    footer.rightAlignText();

    return w;
}

function getRiskLevel(score) {
    if (score <= 25) return { text: "ä½é£é™© (å®‰å…¨)", color: new Color("#28a745") };
    if (score <= 50) return { text: "ä¸­é£é™© (é¢„è­¦)", color: new Color("#ffc107") };
    if (score <= 75) return { text: "é«˜é£é™© (å±é™©)", color: new Color("#ff8c00") };
    return { text: "æé«˜é£é™© (é«˜å±)", color: new Color("#dc3545") };
}

function getFlagEmoji(countryCode) {
    if (!countryCode) return "ğŸŒ";
    return countryCode.toUpperCase().replace(/./g, char => 
        String.fromCodePoint(127397 + char.charCodeAt())
    );
}
