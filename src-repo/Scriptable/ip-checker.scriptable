// IPPure é£é™©ç›‘æµ‹ - ç»ˆæç´«è‰²éœ“è™¹ç‰ˆ
const url = "https://my.ippure.com/v1/info";

async function fetchData() {
  try {
    let req = new Request(url);
    req.timeoutInterval = 8;
    return await req.loadJSON();
  } catch (e) { return null; }
}

const data = await fetchData();
let widget = await createWidget(data);

if (!config.runsInWidget) {
  await widget.presentMedium();
}
Script.setWidget(widget);
Script.complete();

async function createWidget(data) {
  let w = new ListWidget();
  w.setPadding(8, 12, 8, 12);

  // --- é¢œè‰²å®šä¹‰ ---
  const isDark = Device.isUsingDarkAppearance();
  const purpleNeon = new Color("#8165AC"); // æ ¸å¿ƒç´«è‰²
  const purpleGlow = new Color("#8165AC", 0.3); // å‘å…‰å±‚
  const mainTextColor = Color.dynamic(new Color("#1C1C1E"), new Color("#FFFFFF"));
  
  // æ·±é‚ƒèƒŒæ™¯æ¸å˜
  let gradient = new LinearGradient();
  gradient.colors = isDark ? 
    [new Color("#0D0D0F"), new Color("#050505")] : 
    [new Color("#F5F5F7"), new Color("#FFFFFF")];
  w.backgroundGradient = gradient;

  if (!data) {
    let msg = w.addText("âš ï¸ æ­£åœ¨æ‰«æç½‘ç»œ...");
    msg.textColor = purpleNeon;
    msg.centerAlignText();
    return w;
  }

  const score = data.fraudScore || 0;
  const flag = getFlagEmoji(data.countryCode);

  let mainStack = w.addStack();
  mainStack.centerAlignContent();

  // --- å·¦ä¾§ä¿¡æ¯æ€»æ  ---
  let leftStack = mainStack.addStack();
  leftStack.layoutVertically();
  
  const addNeonInfo = (label, value) => {
    let rowStack = leftStack.addStack();
    rowStack.centerAlignContent();
    
    // 1. å·¦ä¾§ç´«è‰²æ–¹æ¡†æ ‡ç­¾
    let labelStack = rowStack.addStack();
    labelStack.size = new Size(42, 22); // å®½åº¦å¢åŠ ä»¥å®¹çº³æ±‰å­—
    labelStack.centerAlignContent();

    let boxStack = labelStack.addStack();
    boxStack.size = new Size(38, 18); 
    boxStack.cornerRadius = 4;
    boxStack.borderWidth = 1.5; 
    boxStack.borderColor = purpleNeon;
    boxStack.backgroundColor = new Color(purpleNeon.hex, 0.1);
    boxStack.centerAlignContent();
    
    let lText = boxStack.addText(label);
    lText.font = Font.boldSystemFont(9);
    lText.textColor = purpleNeon;
    
    rowStack.addSpacer(6); 

    // 2. å³ä¾§ç´«è‰²æ¤­åœ†æ•°å€¼å®¹å™¨
    let infoValueStack = rowStack.addStack();
    infoValueStack.size = new Size(120, 20); 
    infoValueStack.cornerRadius = 10; 
    infoValueStack.borderWidth = 2; 
    infoValueStack.borderColor = purpleNeon;
    infoValueStack.backgroundColor = Color.dynamic(new Color("#8165AC", 0.05), new Color("#FFFFFF", 0.05));
    infoValueStack.setPadding(0, 8, 0, 8);
    infoValueStack.centerAlignContent();

    let vText = infoValueStack.addText(value);
    vText.font = Font.boldSystemFont(10);
    vText.textColor = mainTextColor;
    vText.lineLimit = 1;
    vText.minimumScaleFactor = 0.6;
    
    leftStack.addSpacer(3); 
  };

  // æŒ‰ç…§ä½ çš„è¦æ±‚æ›´æ–°ï¼šIPä½ç½®, IPåœ°å€, ISP, ASN, IPç±»å‹
  addNeonInfo("IPä½ç½®", `${flag} ${data.countryCode || 'UN'} Â· ${data.city || 'æœªçŸ¥'}`);
  addNeonInfo("IPåœ°å€", data.ip || "N/A");
  addNeonInfo("ISP", data.asOrganization || "N/A");
  addNeonInfo("ASN", data.asn ? `AS${data.asn}` : "N/A");
  addNeonInfo("IPç±»å‹", data.isResidential ? "ä½å®…ç½‘ç»œ" : "æ•°æ®ä¸­å¿ƒ");
  
  leftStack.addSpacer(2);
  let time = leftStack.addText(`SECURITY SCAN: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`);
  time.font = Font.systemFont(8);
  time.textColor = purpleNeon;
  time.textOpacity = 0.6;

  mainStack.addSpacer();

  // --- å³ä¾§åœ†ç¯æ  (ç´«è‰²éœ“è™¹è´¨æ„Ÿ) ---
  let rightStack = mainStack.addStack();
  let ringStack = rightStack.addStack();
  ringStack.size = new Size(95, 95);
  ringStack.centerAlignContent();

  let canvas = new DrawContext();
  const cSize = 200;
  canvas.size = new Size(cSize, cSize);
  canvas.opaque = false;
  
  // 1. åº•å±‚éœ“è™¹æ™•å…‰
  canvas.setLineWidth(14);
  canvas.setStrokeColor(purpleGlow);
  canvas.strokeEllipse(new Rect(10, 10, cSize-20, cSize-20));
  
  // 2. ç»˜åˆ¶ç´«è‰²éœ“è™¹è¿›åº¦ (å¤šç‚¹å †å æ¨¡æ‹Ÿå‘å…‰)
  const deg = (score / 100) * 360;
  for (let i = 0; i <= deg; i += 2) {
    // æ¸å˜æ„Ÿï¼šä»æ·±ç´«åˆ°äº®ç´«
    let opacity = 0.5 + (i / 720);
    canvas.setStrokeColor(new Color(purpleNeon.hex, opacity));
    
    let x = cSize/2 + (cSize/2-10) * Math.cos((i-90) * Math.PI/180);
    let y = cSize/2 + (cSize/2-10) * Math.sin((i-90) * Math.PI/180);
    
    // ç»˜åˆ¶ä¸»å…‰ç‚¹
    canvas.fillEllipse(new Rect(x-8, y-8, 16, 16));
    // ç»˜åˆ¶æ ¸å¿ƒäº®ç™½ç‚¹ï¼Œæ¨¡æ‹Ÿç¯ç®¡ä¸­å¿ƒ
    canvas.setFillColor(new Color("#FFFFFF", 0.4));
    canvas.fillEllipse(new Rect(x-3, y-3, 6, 6));
  }
  
  ringStack.backgroundImage = canvas.getImage();
  
  let centerColumn = ringStack.addStack();
  centerColumn.layoutVertically();
  
  let scoreText = centerColumn.addText(`${score}`);
  scoreText.font = Font.boldSystemFont(28);
  scoreText.textColor = mainTextColor;
  scoreText.centerAlignText();
  
  let riskText = centerColumn.addText("RISK");
  riskText.font = Font.boldSystemFont(10);
  riskText.textColor = purpleNeon;
  riskText.centerAlignText();

  return w;
}

function getFlagEmoji(countryCode) {
  if (!countryCode) return "ğŸŒ";
  return countryCode.toUpperCase().replace(/./g, char => 
    String.fromCodePoint(127397 + char.charCodeAt())
  );
}
