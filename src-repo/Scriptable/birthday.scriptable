// --- é…ç½®åŒºåŸŸ ---
const FAMILY_MEMBERS = [
  { name: "å¦ˆå¦ˆ ğŸ‚", lunarMonth: 2, lunarDay: 12 },
  { name: "çˆ¸çˆ¸ ğŸ‘¨", lunarMonth: 5, lunarDay: 18 },
  { name: "å¥¶å¥¶ ğŸ‘µ", lunarMonth: 10, lunarDay: 1 },
];

const TITLE_COLOR = Color.white();
const DAYS_COLOR = new Color("#ffcc00");
const BG_COLOR = new Color("#1c1c1e");

// --- æ ¸å¿ƒé€»è¾‘ ---

// å†œå†è½¬å…¬å†å‡½æ•°
async function getSolarBirthday(lunarMonth, lunarDay) {
  const now = new Date();
  const currentYear = now.getFullYear();
  
  // å°è¯•è·å–ä»Šå¹´çš„å…¬å†æ—¥æœŸ
  let solarDate = await fetchSolarDate(currentYear, lunarMonth, lunarDay);
  
  // å¦‚æœä»Šå¹´ç”Ÿæ—¥å·²è¿‡ï¼Œåˆ™è®¡ç®—æ˜å¹´çš„
  if (solarDate < now) {
    solarDate = await fetchSolarDate(currentYear + 1, lunarMonth, lunarDay);
  }
  return solarDate;
}

// å…·ä½“çš„ API è¯·æ±‚å°è£…
async function fetchSolarDate(year, month, day) {
  try {
    const url = `https://www.iamwawa.cn/home/nongli/ajax?type=lunar&year=${year}&month=${month}&day=${day}`;
    const req = new Request(url);
    const res = await req.loadJSON();
    if (res && res.data && res.data.solar) {
      // res.data.solar æ ¼å¼ä¸º "2024-03-21"
      return new Date(res.data.solar.replace(/-/g, "/"));
    }
  } catch (e) {
    console.error("APIè¯·æ±‚å¤±è´¥: " + e);
  }
  return new Date(); // å¤±è´¥å›é€€
}

// ä¸»æ¸²æŸ“å‡½æ•°
async function run() {
  let widget = new ListWidget();
  widget.backgroundColor = BG_COLOR;
  widget.setPadding(15, 15, 15, 15);

  let header = widget.addText("ğŸ® å†œå†ç”Ÿæ—¥å€’è®¡æ—¶");
  header.textColor = Color.gray();
  header.font = Font.systemFont(11);
  widget.addSpacing(10);

  let results = [];
  for (let person of FAMILY_MEMBERS) {
    let solarDate = await getSolarBirthday(person.lunarMonth, person.lunarDay);
    let diff = solarDate.getTime() - new Date().getTime();
    let days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    results.push({ name: person.name, days: days });
  }

  // æ’åºï¼šå¤©æ•°å°‘çš„åœ¨å‰
  results.sort((a, b) => a.days - b.days);

  for (let item of results) {
    let row = widget.addStack();
    row.centerAlignContent();
    
    let nameTxt = row.addText(item.name);
    nameTxt.textColor = TITLE_COLOR;
    nameTxt.font = Font.boldSystemFont(15);
    
    row.addSpacer();
    
    let numTxt = row.addText(item.days.toString());
    numTxt.textColor = (item.days <= 7) ? Color.red() : DAYS_COLOR; // 7å¤©å†…å˜çº¢
    numTxt.font = Font.boldSystemFont(18);
    
    let unitTxt = row.addText(" å¤©");
    unitTxt.textColor = Color.gray();
    unitTxt.font = Font.systemFont(12);
    
    widget.addSpacing(8);
  }

  if (config.runsInWidget) {
    Script.setWidget(widget);
  } else {
    widget.presentSmall();
  }
  Script.complete();
}

// å¯åŠ¨è„šæœ¬
await run();
