// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: teal; icon-glyph: cake;

// 1. å¯¼å…¥ä¾èµ–
const DmYY = importModule('DmYY');
const Lunar = importModule('lunar'); // å‡è®¾ä½ çš„æ–‡ä»¶åæ˜¯ lunar.js æˆ– lunar.module.js

class FamilyBirthday extends DmYY {
  constructor(arg) {
    // é»˜è®¤é…ç½®é¡¹ï¼šä»…ä¿ç•™å¤´åƒå’Œå†œå†æ—¥æœŸ
    const defaultSettings = {
      family: [
        { name: "çˆ¸çˆ¸", month: 3, day: 15, emoji: "ğŸ‘¨" },
        { name: "å¦ˆå¦ˆ", month: 6, day: 20, emoji: "ğŸ‘©" },
        { name: "å¦¹å¦¹", month: 9, day: 5,  emoji: "ğŸ‘§" },
        { name: "æˆ‘",   month: 11, day: 8,  emoji: "ğŸ‘¦" }
      ]
    };
    super(arg, defaultSettings);
  }

  // --- é…ç½®èœå•ï¼šç‚¹å‡»è„šæœ¬å¼¹å‡º ---
  async showMyMenu() {
    const actions = [];
    this.settings.family.forEach((person, index) => {
      actions.push({
        title: `${person.emoji} ä¿®æ”¹ ${person.name} çš„ç”Ÿæ—¥`,
        onClick: async () => { await this.editPerson(index); }
      });
    });
    
    await this.registerAction('ğŸ‚ ç”Ÿæ—¥è®¾ç½®', actions);
    return await this.renderAction();
  }

  // ç®€åŒ–ç‰ˆç¼–è¾‘ç•Œé¢
  async editPerson(index) {
    const p = this.settings.family[index];
    const a = new Alert();
    a.title = `è®¾ç½® ${p.name} çš„ä¿¡æ¯`;
    a.addTextField("å¤´åƒ Emoji", p.emoji);
    a.addTextField("å†œå†æœˆä»½ (æ•°å­—)", p.month.toString());
    a.addTextField("å†œå†æ—¥æœŸ (æ•°å­—)", p.day.toString());
    a.addAction("ç¡®è®¤ä¿å­˜");
    a.addCancelAction("å–æ¶ˆ");
    
    if (await a.present() === 0) {
      this.settings.family[index].emoji = a.textFieldValue(0);
      this.settings.family[index].month = parseInt(a.textFieldValue(1));
      this.settings.family[index].day = parseInt(a.textFieldValue(2));
      this.saveSettings();
    }
  }

  // --- æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ ---
  async render() {
    const listWidget = new ListWidget();
    const now = new Date();
    const currentYear = now.getFullYear();

    // 1. å¤„ç†æ•°æ®å¹¶è®¡ç®—å…¬å†æ—¥æœŸ
    let bDayPerson = null;
    const processed = this.settings.family.map(p => {
      // ä½¿ç”¨ lunar æ¨¡å—è®¡ç®—å…¬å†
      let solar = this.getSolarFromLunar(currentYear, p.month, p.day);
      // å¦‚æœä»Šå¹´å·²ç»è¿‡äº†ï¼Œç®—æ˜å¹´çš„
      if (now.getTime() > solar.getTime() + 86400000) {
        solar = this.getSolarFromLunar(currentYear + 1, p.month, p.day);
      }
      
      const isToday = now.toDateString() === solar.toDateString();
      if (isToday) bDayPerson = p;
      return { ...p, solar, isToday };
    });

    // 2. è§†è§‰èƒŒæ™¯
    if (bDayPerson) {
      listWidget.backgroundGradient = this.getGradient("#e52d27", "#b31217");
    } else {
      listWidget.backgroundColor = new Color("#1c1c1e");
    }
    listWidget.setPadding(12, 12, 12, 12);

    // 3. ç»˜åˆ¶å››äººç»„å¸ƒå±€
    const hStack = listWidget.addStack();
    hStack.layoutHorizontally();
    hStack.bottomAlignContent();

    processed.forEach((p, i) => {
      const vStack = hStack.addStack();
      vStack.layoutVertically();
      vStack.centerAlignContent();

      // åœ¨ä¸€ä¸ªç”»å¸ƒä¸Šç»˜åˆ¶ Emoji å’Œåœ†ç¯ï¼Œè§£å†³å¯¹é½é—®é¢˜
      const canvas = new DrawContext();
      canvas.size = new Size(120, 120);
      canvas.opaque = false;

      // ç»˜åˆ¶ Emoji
      canvas.setFont(Font.systemFont(34));
      canvas.setTextAlignedCenter();
      canvas.drawTextInRect(p.emoji, new Rect(0, 0, 120, 45));

      // ç»˜åˆ¶åœ†ç¯
      const diff = p.solar - now;
      const progress = p.isToday ? 1 : Math.max(0.1, 1 - (diff / (365 * 86400000)));
      this.drawArc(canvas, progress, p.isToday);

      const img = vStack.addImage(canvas.getImage());
      img.imageSize = new Size(70, 70);

      vStack.addSpacer(2);

      // ç»˜åˆ¶æ—¥æœŸæ–‡å­—
      const df = new DateFormatter();
      df.dateFormat = "yyyy-MM-dd";
      const dateText = vStack.addText(p.isToday ? "HAPPY" : df.string(p.solar));
      dateText.font = Font.boldSystemFont(9);
      dateText.textColor = Color.white();
      dateText.centerAlignText();

      if (i < processed.length - 1) hStack.addSpacer();
    });

    // 4. åº•éƒ¨å¹´åº¦è¿›åº¦æ¡
    listWidget.addSpacer();
    this.renderYearBar(listWidget, bDayPerson);

    return listWidget;
  }

  // åˆ©ç”¨ lunar æ¨¡å—è¿›è¡Œè½¬æ¢
  getSolarFromLunar(y, m, d) {
    // é€‚é… lunar.js çš„å…¸å‹è°ƒç”¨æ–¹å¼ï¼šlunar.toSolar(å¹´, æœˆ, æ—¥)
    // æ³¨æ„ï¼šå¦‚æœæ˜¯é—°æœˆï¼Œæ¨¡å—é€šå¸¸æœ‰ç‰¹æ®Šå‚æ•°ï¼Œæ­¤å¤„æŒ‰æ™®é€šå†œå†å¤„ç†
    const solardate = Lunar.toSolar(y, m, d);
    return new Date(solardate.year, solardate.month - 1, solardate.day);
  }

  // ç»˜å›¾è¾…åŠ©ï¼šåœ†ç¯
  drawArc(ctx, progress, isToday) {
    const center = { x: 60, y: 85 };
    const radius = 35;
    const thick = 6;
    // èƒŒæ™¯ç¯
    ctx.setFillColor(new Color("#ffffff", 0.1));
    for (let a=0; a<360; a+=2) {
      const x = center.x + radius * Math.cos(a*Math.PI/180);
      const y = center.y + radius * Math.sin(a*Math.PI/180);
      ctx.fillEllipse(new Rect(x-thick/2, y-thick/2, thick, thick));
    }
    // è¿›åº¦ç¯
    ctx.setFillColor(isToday ? Color.green() : new Color("#ffd60a"));
    for (let a=180; a<180 + (180*progress); a+=2) {
      const x = center.x + radius * Math.cos(a*Math.PI/180);
      const y = center.y + radius * Math.sin(a*Math.PI/180);
      ctx.fillEllipse(new Rect(x-thick/2, y-thick/2, thick, thick));
    }
  }

  // æ¸²æŸ“å¹´åº¦è¿›åº¦æ¡
  renderYearBar(widget, isBday) {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const end = new Date(now.getFullYear() + 1, 0, 1);
    const yp = (now - start) / (end - start);
    const daysLeft = Math.ceil((end - now) / 86400000);

    const stack = widget.addStack();
    stack.layoutVertically();
    
    const label = stack.addStack();
    const t1 = label.addText(`${now.getFullYear()} è¿›åº¦ ${Math.floor(yp*100)}%`);
    t1.font = Font.systemFont(9); t1.textColor = Color.white(); t1.textOpacity = 0.5;
    label.addSpacer();
    const t2 = label.addText(`å‰© ${daysLeft} å¤©`);
    t2.font = Font.systemFont(9); t2.textColor = Color.white(); t2.textOpacity = 0.5;

    stack.addSpacer(4);
    
    const barW = 310;
    const ctx = new DrawContext();
    ctx.size = new Size(barW, 8);
    ctx.opaque = false;
    const bgP = new Path(); bgP.addRoundedRect(new Rect(0,0,barW,8),4,4);
    ctx.addPath(bgP); ctx.setFillColor(new Color("#ffffff",0.15)); ctx.fillPath();
    const fgP = new Path(); fgP.addRoundedRect(new Rect(0,0,barW*yp,8),4,4);
    ctx.addPath(fgP); ctx.setFillColor(isBday ? Color.yellow() : Color.green()); ctx.fillPath();
    stack.addImage(ctx.getImage());
  }

  getGradient(c1, c2) {
    let g = new LinearGradient();
    g.colors = [new Color(c1), new Color(c2)];
    g.locations = [0, 1];
    return g;
  }
}

// å¯åŠ¨
const w = new FamilyBirthday(args.widgetParameter);
if (config.runsInApp) {
  await w.showMyMenu();
} else {
  const widget = await w.render();
  Script.setWidget(widget);
}
Script.complete();
