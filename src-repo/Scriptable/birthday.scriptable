// Variables used by Scriptable.
// icon-color: red; icon-glyph: cake;

const GITHUB_URL = "https://raw.githubusercontent.com/SHanQ7/Alaric/refs/heads/main/src-repo/Scriptable/birthday.scriptable";
const fm = FileManager.local();
const dataPath = fm.joinPath(fm.documentsDirectory(), "lunar_birthday_data.json");

let familyData = [{name:"çˆ¸çˆ¸",m:3,d:15,e:"ğŸ‘¨"},{name:"å¦ˆå¦ˆ",m:6,d:20,e:"ğŸ‘©"},{name:"å¦¹å¦¹",m:9,d:5,e:"ğŸ‘§"},{name:"æˆ‘",m:11,d:8,e:"ğŸ‘¦"}];
if(fm.fileExists(dataPath)) familyData = JSON.parse(fm.readString(dataPath));

/**
 * æ ¸å¿ƒä¿®å¤ï¼šæ›´ç¨³å¥çš„å†œå†è½¬å…¬å†é€»è¾‘
 * è§£å†³ RangeError: date value is not finite é—®é¢˜
 */
function getSolar(y, m, d) {
  // å†œå†æ—¥æœŸå¯¹åº”çš„å…¬å†èŒƒå›´å¤§çº¦åœ¨å…¬å†å¹´çš„ 1æœˆåˆ°æ¬¡å¹´2æœˆ
  let startDate = new Date(y, 0, 1);
  let endDate = new Date(y + 1, 2, 1);
  
  let current = new Date(startDate);
  // é™åˆ¶å¾ªç¯æ¬¡æ•°ï¼Œé˜²æ­¢æ­»å¾ªç¯
  for (let i = 0; i < 400; i++) {
    try {
      let parts = new Intl.DateTimeFormat('zh-u-ca-chinese').formatToParts(current);
      let lm = parseInt(parts.find(p => p.type === 'month').value);
      let ld = parseInt(parts.find(p => p.type === 'day').value);
      
      // åŒ¹é…æœˆä»½å’Œæ—¥æœŸ
      if (lm === m && ld === d) {
        return new Date(current.getTime());
      }
    } catch (e) {}
    current.setDate(current.getDate() + 1);
    if (current > endDate) break;
  }
  return null;
}

function getNextBirthday(m, d) {
  const now = new Date();
  now.setHours(0,0,0,0);
  let s = getSolar(now.getFullYear(), m, d);
  // å¦‚æœä»Šå¹´ç”Ÿæ—¥å·²è¿‡ï¼Œè®¡ç®—æ˜å¹´çš„
  if (!s || s < now) {
    s = getSolar(now.getFullYear() + 1, m, d);
  }
  return s;
}

// --- UI ç»˜åˆ¶ (é’ˆå¯¹ iPhone 13 ä¼˜åŒ–) ---
async function createWidget() {
  const w = new ListWidget();
  const now = new Date();
  now.setHours(0,0,0,0);
  
  let todayBday = null;
  const data = familyData.map(p => {
    const s = getNextBirthday(p.m, p.d);
    const isT = s && (now.getTime() === s.getTime());
    if(isT) todayBday = p;
    return {...p, s, isT};
  });

  w.backgroundColor = todayBday ? new Color("#b31217") : new Color("#1c1c1e");
  w.setPadding(10, 4, 10, 4);
  
  const mainStack = w.addStack();
  mainStack.layoutHorizontally();
  mainStack.centerAlignContent();

  data.forEach((p, i) => {
    const vStack = mainStack.addStack();
    vStack.layoutVertically();
    
    const cv = new DrawContext();
    cv.size = new Size(240, 280); // å¢åŠ é«˜åº¦ï¼Œå½»åº•æ‹‰å¼€é—´è·
    cv.opaque = false;

    // 1. å¤´åƒï¼šç½®äºç”»å¸ƒé¡¶éƒ¨
    cv.setFont(Font.systemFont(80));
    cv.setTextAlignedCenter();
    cv.drawTextInRect(p.e, new Rect(0, 0, 240, 100));

    // 2. å¼§çº¿ï¼šä½äºå¤´åƒä¸‹æ–¹ï¼Œå¤§å¹…ä¸‹ç§»
    const center = {x: 120, y: 170}; // yè½´ä¸‹ç§»åˆ°170
    const radius = 90; 
    const thick = 14; // å¼§çº¿ç‚¹åŠ ç²—
    
    const diff = p.s ? (p.s - now) / (1000 * 60 * 60 * 24) : 0;
    const progress = p.isT ? 1 : Math.max(0.05, 1 - (diff / 365));
    
    // ç»˜åˆ¶ç°è‰²åº•å¼§
    cv.setFillColor(new Color("#ffffff", 0.15));
    for(let a=190; a<=350; a+=4){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }
    
    // ç»˜åˆ¶å½©è‰²è¿›åº¦å¼§
    cv.setFillColor(p.isT ? Color.green() : Color.yellow());
    for(let a=190; a<=190+(160*progress); a+=3.5){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }

    // 3. æ—¥æœŸï¼šæ”¾ç½®åœ¨å¼§çº¿å¼€å£çš„æ­£ä¸­å¿ƒä½ç½®ï¼Œç»ä¸é‡å 
    const df = new DateFormatter();
    df.dateFormat = "MM-dd";
    cv.setFont(Font.heavySystemFont(34)); // è¶…é‡ç£…ç²—ä½“
    cv.setTextColor(Color.white());
    // è¿™é‡Œçš„ y=185 æ˜¯å…³é”®ï¼Œç¡®ä¿å®ƒåœ¨å¼§çº¿ç‚¹ä¸‹æ–¹
    cv.drawTextInRect(p.isT ? "BIRTH" : (p.s ? df.string(p.s) : "ERR"), new Rect(0, 185, 240, 80));

    const img = vStack.addImage(cv.getImage());
    img.imageSize = new Size(82, 95);
    
    if(i < data.length-1) mainStack.addSpacer();
  });

  // --- åº•éƒ¨å¹´åº¦è¿›åº¦æ¡ ---
  w.addSpacer();
  const startYear = new Date(now.getFullYear(), 0, 1);
  const endYear = new Date(now.getFullYear() + 1, 0, 1);
  const yearProgress = (now - startYear) / (endYear - startYear);

  const btmStack = w.addStack();
  btmStack.layoutVertically();
  btmStack.setPadding(0, 15, 5, 15);
  
  const progText = btmStack.addText(`${now.getFullYear()} è¿›åº¦ ${Math.floor(yearProgress*100)}%`);
  progText.font = Font.boldSystemFont(14);
  progText.textColor = Color.white();
  btmStack.addSpacer(6);
  
  const barCanvas = new DrawContext();
  barCanvas.size = new Size(330, 16);
  barCanvas.setFillColor(new Color("#ffffff", 0.2));
  barCanvas.fillPath(new Path().addRoundedRect(new Rect(0,0,330,16),8,8));
  barCanvas.setFillColor(todayBday ? Color.yellow() : Color.green());
  barCanvas.fillPath(new Path().addRoundedRect(new Rect(0,0,330*yearProgress,16),8,8));
  btmStack.addImage(barCanvas.getImage());

  return w;
}

// --- æ§åˆ¶é¢æ¿ ---
async function showControlPanel() {
  const a = new Alert();
  a.title = "ğŸ‚ ç”Ÿæ—¥ç®¡å®¶ v3.0";
  familyData.forEach(p => a.addAction(`${p.e} ${p.name}`));
  a.addAction("ğŸ‘€ é¢„è§ˆç»„ä»¶");
  a.addDestructiveAction("ğŸ”„ å¼ºåˆ¶æ›´æ–°è„šæœ¬");
  const i = await a.presentSheet();
  
  if(i === familyData.length) { 
    const widget = await createWidget();
    await widget.presentMedium(); 
  } else if(i === familyData.length + 1) { 
    let r = new Request(GITHUB_URL);
    try {
      let content = await r.loadString();
      if(content.includes("Script.setWidget")) {
        fm.writeString(module.filename, content);
        const ok = new Alert(); ok.title="æ›´æ–°æˆåŠŸï¼Œè¯·é‡æ–°è¿è¡Œ"; await ok.present();
      }
    } catch(e) {
      const err = new Alert(); err.title="æ›´æ–°å¤±è´¥"; await err.present();
    }
  }
}

// å¯åŠ¨
if(!config.runsInApp) {
  const w = await createWidget();
  Script.setWidget(w);
  Script.complete();
} else {
  await showControlPanel();
}
