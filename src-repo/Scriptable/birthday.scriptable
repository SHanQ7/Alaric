// --- ÈÖçÁΩÆÂå∫Âüü ---
const FAMILY_MEMBERS = [
  { name: "Â¶àÂ¶à", lunarMonth: 2, lunarDay: 12 }, // ÂÜúÂéÜ‰∫åÊúàÂçÅ‰∫å
  { name: "Áà∏Áà∏", lunarMonth: 5, lunarDay: 18 }, // ÂÜúÂéÜ‰∫îÊúàÂçÅÂÖ´
  { name: "Â•∂Â•∂", lunarMonth: 10, lunarDay: 1 }, // ÂÜúÂéÜÂçÅÊúàÂàù‰∏Ä
];

// È¢úËâ≤‰∏ªÈ¢ò
const TITLE_COLOR = Color.white();
const DAYS_COLOR = new Color("#ffcc00");
const BG_COLOR = new Color("#1c1c1e");

// --- Ê†∏ÂøÉÈÄªËæë ---

// Ëé∑ÂèñÂÜúÂéÜÂØπÂ∫îÁöÑÂÖ¨ÂéÜÊó•ÊúüÔºàÁ≤æÁÆÄÁâàËΩ¨Êç¢ÈÄªËæëÔºâ
async function getNextLunarBirthday(lunarMonth, lunarDay) {
  let now = new Date();
  let currentYear = now.getFullYear();
  
  // ‰ΩøÁî®ÂÜÖÁΩÆ API Ëé∑ÂèñÂΩìÂπ¥ÁöÑÂÖ¨ÂéÜÊó•Êúü
  async function lunarToSolar(year, month, day) {
    let url = `https://www.iamwawa.cn/home/nongli/ajax?type=lunar&year=${year}&month=${month}&day=${day}`;
    let req = new Request(url);
    let res = await req.loadJSON();
    // Êé•Âè£ËøîÂõûÊ†ºÂºèÔºöres.data.solar (YYYY-MM-DD)
    return new Date(res.data.solar);
  }

  // Ëé∑Âèñ‰ªäÂπ¥ÁöÑÂÜúÂéÜËΩ¨ÂÖ¨ÂéÜ
  let solarDate = await lunarToSolar(currentYear, lunarMonth, lunarDay);
  
  // Â¶ÇÊûú‰ªäÂπ¥ÁîüÊó•Â∑≤ËøáÔºåËÆ°ÁÆóÊòéÂπ¥ÁöÑ
  if (now > solarDate) {
    solarDate = await lunarToSolar(currentYear + 1, lunarMonth, lunarDay);
  }
  
  return solarDate;
}

// ÊûÑÂª∫ÁªÑ‰ª∂
async function createWidget() {
  let widget = new ListWidget();
  widget.backgroundColor = BG_COLOR;
  widget.setPadding(15, 15, 15, 15);

  let header = widget.addText("üèÆ ÂÜúÂéÜÁîüÊó•ÂÄíËÆ°Êó∂");
  header.textColor = Color.gray();
  header.font = Font.systemFont(11);
  widget.addSpacing(10);

  // Âæ™ÁéØËÆ°ÁÆóÊâÄÊúâÂÆ∂‰∫∫
  let results = [];
  for (let person of FAMILY_MEMBERS) {
    let solarBirthday = await getNextLunarBirthday(person.lunarMonth, person.lunarDay);
    let diff = solarBirthday.getTime() - new Date().getTime();
    let days = Math.ceil(diff / (1000 * 60 * 60 * 24));
    results.push({ name: person.name, days: days });
  }

  // ÊéíÂ∫è
  results.sort((a, b) => a.days - b.days);

  // Ê∏≤Êüì UI
  for (let item of results) {
    let row = widget.addStack();
    row.centerAlignContent();
    
    let nameTxt = row.addText(item.name);
    nameTxt.textColor = TITLE_COLOR;
    nameTxt.font = Font.boldSystemFont(15);
    
    row.addSpacer();
    
    let numTxt = row.addText(item.days.toString());
    numTxt.textColor = DAYS_COLOR;
    numTxt.font = Font.boldSystemFont(18);
    
    let unitTxt = row.addText(" Â§©");
    unitTxt.textColor = Color.gray();
    unitTxt.font = Font.systemFont(12);
    
    widget.addSpacing(8);
  }

  return widget;
}

// --- ËøêË°å ---
let widget = await createWidget();
if (config.runsInWidget) {
  Script.setWidget(widget);
} else {
  widget.presentSmall();
}
Script.complete();
