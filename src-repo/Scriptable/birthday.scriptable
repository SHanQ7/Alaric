// Variables used by Scriptable.
// icon-color: red; icon-glyph: cake;

// 1. å¯¼å…¥æ‚¨çš„å†œå†æ¨¡å— (ç¡®ä¿æ–‡ä»¶åå« lunar.module)
const lunar = importModule('lunar.module');

const fm = FileManager.local();
const dataPath = fm.joinPath(fm.documentsDirectory(), "lunar_birthday_data.json");
const GITHUB_URL = "https://raw.githubusercontent.com/SHanQ7/Alaric/refs/heads/main/src-repo/Scriptable/birthday.scriptable";

// åˆå§‹æ•°æ®
let familyData = [
  {name:"çˆ¸çˆ¸",m:3,d:15,e:"ğŸ‘¨"},
  {name:"å¦ˆå¦ˆ",m:6,d:20,e:"ğŸ‘©"},
  {name:"å¦¹å¦¹",m:9,d:5,e:"ğŸ‘§"},
  {name:"æˆ‘",m:11,d:8,e:"ğŸ‘¦"}
];
if(fm.fileExists(dataPath)) familyData = JSON.parse(fm.readString(dataPath));

// --- æ ¸å¿ƒé€»è¾‘ï¼šè®¡ç®—ä¸‹ä¸€æ¬¡å…¬å†ç”Ÿæ—¥ ---
function getNextSolarDate(targetMonth, targetDay) {
  const now = new Date();
  const currentYear = now.getFullYear();
  const monthNames = ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'];
  
  const findInYear = (year) => {
    let start = new Date(year, 0, 1);
    for (let i = 0; i < 400; i++) {
      let d = new Date(start.getTime() + i * 24 * 3600 * 1000);
      let res = lunar.sloarToLunar(d.getFullYear(), d.getMonth() + 1, d.getDate());
      
      let mStr = res.lunarMonth.replace('é—°', '');
      let mIndex = monthNames.indexOf(mStr) + 1;
      let dNum = lunarDayToNum(res.lunarDay);

      if (mIndex === targetMonth && dNum === targetDay && !res.lunarMonth.includes('é—°')) {
        return d;
      }
    }
    return null;
  };

  let s = findInYear(currentYear);
  if (!s || s < new Date(now.setHours(0,0,0,0))) s = findInYear(currentYear + 1);
  return s;
}

// ä¿®å¤åçš„æ—¥æœŸè§£æå‡½æ•°ï¼Œå¢åŠ å¥å£®æ€§
function lunarDayToNum(dStr) {
  if (!dStr || typeof dStr !== 'string' || dStr.length < 2) return 1;
  const dict = {"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5,"å…­":6,"ä¸ƒ":7,"å…«":8,"ä¹":9};
  
  // ç‰¹æ®Šæƒ…å†µç›´æ¥è¿”å›
  if (dStr === "åˆå") return 10;
  if (dStr === "äºŒå") return 20;
  if (dStr === "ä¸‰å") return 30;
  
  let b = 0;
  if (dStr[0] === "å") b = 10;
  else if (dStr[0] === "å»¿") b = 20;
  else if (dStr[0] === "å…") b = 30;
  else if (dStr[0] === "åˆ") b = 0;
  
  return b + (dict[dStr[1]] || 0);
}

// --- UI ç»˜åˆ¶ (iPhone 13 ç‰©ç†éš”ç¦»å¸ƒå±€) ---
async function createWidget() {
  const w = new ListWidget();
  const now = new Date(); now.setHours(0,0,0,0);
  let todayP = null;

  const data = familyData.map(p => {
    const s = getNextSolarDate(p.m, p.d);
    const isT = s && (now.getTime() === s.getTime());
    if(isT) todayP = p;
    return {...p, s, isT};
  });

  w.backgroundColor = todayP ? new Color("#b31217") : new Color("#1c1c1e");
  w.setPadding(12, 5, 12, 5);
  const mainS = w.addStack();

  data.forEach((p, i) => {
    const col = mainS.addStack();
    col.layoutVertically();
    
    // 1. å¤´åƒå±‚
    const eS = col.addStack(); eS.addSpacer();
    const tE = eS.addText(p.e); tE.font = Font.systemFont(44);
    eS.addSpacer();
    
    col.addSpacer(10); // ç‰©ç†éš”ç¦»ç©ºéš™

    // 2. ç»˜å›¾å±‚ (åœ†å¼§ + æ—¥æœŸ)
    const cv = new DrawContext();
    cv.size = new Size(200, 200); cv.opaque = false;
    const center = {x: 100, y: 90}, radius = 78, thick = 12;
    const diff = p.s ? (p.s - now)/(24*3600*1000) : 0;
    const prog = p.isT ? 1 : Math.max(0.1, 1 - (diff/365));

    cv.setFillColor(new Color("#ffffff", 0.15));
    for(let a=190; a<=350; a+=5){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }
    cv.setFillColor(p.isT ? Color.green() : Color.yellow());
    for(let a=190; a<=190+(160*prog); a+=4.5){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }

    // 3. æ—¥æœŸæ–‡å­—å±‚ (Heavy è¶…ç²—ä½“)
    const df = new DateFormatter(); df.dateFormat = "MM-dd";
    cv.setFont(Font.heavySystemFont(32)); cv.setTextColor(Color.white());
    cv.setTextAlignedCenter();
    cv.drawTextInRect(p.isT ? "BIRTH" : (p.s ? df.string(p.s) : "--"), new Rect(0, 105, 200, 65));

    const img = col.addImage(cv.getImage());
    img.imageSize = new Size(82, 82);
    if(i < data.length-1) mainS.addSpacer();
  });

  w.addSpacer();
  const yp = (now - new Date(now.getFullYear(),0,1))/(365*24*3600*1000);
  const btm = w.addStack(); btm.layoutVertically(); btm.setPadding(0, 15, 5, 15);
  const t = btm.addText(`${now.getFullYear()} è¿›åº¦ ${Math.floor(yp*100)}%`);
  t.font = Font.boldSystemFont(13); t.textColor = Color.white();
  btm.addSpacer(5);
  const bc = new DrawContext(); bc.size = new Size(330, 12);
  bc.setFillColor(new Color("#ffffff", 0.2)); bc.fillPath(new Path().addRoundedRect(new Rect(0,0,330,12),6,6));
  bc.setFillColor(todayP ? Color.yellow() : Color.green()); bc.fillPath(new Path().addRoundedRect(new Rect(0,0,330*yp,12),6,6));
  btm.addImage(bc.getImage());

  return w;
}

// --- æ§åˆ¶é¢æ¿ï¼šä¸€è¡Œå¼è¾“å…¥é€»è¾‘ ---
async function showControlPanel() {
  const a = new Alert(); a.title = "ğŸ‚ ç”Ÿæ—¥ç®¡å®¶é…ç½®";
  familyData.forEach(p => a.addAction(`${p.e} ä¿®æ”¹ ${p.name}`));
  a.addAction("ğŸ‘€ é¢„è§ˆç»„ä»¶"); a.addDestructiveAction("ğŸ”„ æ›´æ–°åŠŸèƒ½è„šæœ¬");
  
  const i = await a.presentSheet();
  if (i < familyData.length) {
    const p = familyData[i];
    const edit = new Alert();
    edit.title = `ä¿®æ”¹ ${p.name} çš„ç”Ÿæ—¥`;
    edit.message = "è¯·è¾“å…¥å†œå†æ ¼å¼ï¼Œå¦‚ï¼š\n1980å¹´5æœˆåˆä¸€";
    edit.addTextField("1980å¹´5æœˆåˆä¸€", "");
    edit.addAction("ç¡®å®š"); edit.addCancelAction("å–æ¶ˆ");
    
    if (await edit.present() === 0) {
      const val = edit.textFieldValue(0);
      if (!val) return;
      const m = val.match(/(\d{4})å¹´(\d{1,2})æœˆ(.+)/);
      if (m) {
        const monthNum = parseInt(m[2]);
        const dayNum = lunarDayToNum(m[3]);
        
        familyData[i].m = monthNum;
        familyData[i].d = dayNum;
        
        fm.writeString(dataPath, JSON.stringify(familyData));
        const ok = new Alert(); ok.title = "ä¿å­˜æˆåŠŸ"; await ok.present();
      } else {
        const err = new Alert(); err.title = "è¾“å…¥æ ¼å¼é”™è¯¯"; err.message = "è¯·æŒ‰ç…§ï¼š1980å¹´5æœˆåˆä¸€ æ ¼å¼è¾“å…¥"; await err.present();
      }
    }
  } else if (i === familyData.length) { 
    const w = await createWidget();
    w.presentMedium(); 
  } else if (i === familyData.length + 1) {
    // è¿™é‡Œæ”¾ä½ è‡ªå·±çš„ GitHub æ›´æ–°é€»è¾‘æˆ–ç•™ç©º
  }
}

if(!config.runsInApp) {
  const w = await createWidget(); Script.setWidget(w); Script.complete();
} else { await showControlPanel(); }
