const lunarModule = importModule('lunar.module');

const GITHUB_URL = "https://raw.githubusercontent.com/SHanQ7/Alaric/refs/heads/main/src-repo/Scriptable/birthday.scriptable";
const fm = FileManager.local();
const dataPath = fm.joinPath(fm.documentsDirectory(), "lunar_birthday_data.json");

let familyData = [
  {name:"çˆ¸çˆ¸",m:3,d:15,e:"ğŸ‘¨"},
  {name:"å¦ˆå¦ˆ",m:6,d:20,e:"ğŸ‘©"},
  {name:"å¦¹å¦¹",m:9,d:5,e:"ğŸ‘§"},
  {name:"æˆ‘",m:11,d:8,e:"ğŸ‘¦"}
];
if(fm.fileExists(dataPath)) familyData = JSON.parse(fm.readString(dataPath));

/**
 * åˆ©ç”¨æ¨¡å—è®¡ç®—ä¸‹ä¸€æ¬¡ç”Ÿæ—¥çš„å…¬å†æ—¥æœŸ
 */
function getNextSolarDate(lunarMonth, lunarDay) {
  const now = new Date();
  const currentYear = now.getFullYear();
  
  // æŸ¥æ‰¾å…¬å†æ—¥æœŸçš„å‡½æ•°ï¼šç”±äºæ¨¡å—æ˜¯å†œè½¬å…¬ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å…¬å†æ—¥æœŸä¸­æœç´¢åŒ¹é…å†œå†çš„æ—¥æœŸ
  const findInYear = (year) => {
    // ç”Ÿæ—¥å¤§è‡´åœ¨å†œå†æœˆå¯¹åº”çš„å…¬å†èŒƒå›´å†…ï¼Œæœç´¢è¯¥å¹´åŠå…¶åä¸¤ä¸ªæœˆ
    let start = new Date(year, 0, 1);
    for (let i = 0; i < 400; i++) {
      let d = new Date(start.getTime() + i * 24 * 3600 * 1000);
      let res = lunarModule.sloarToLunar(d.getFullYear(), d.getMonth() + 1, d.getDate());
      
      // åŒ¹é…æœˆä»½å’Œæ—¥æœŸï¼ˆè½¬æ¢æ¨¡å—è¿”å›æ±‰å­—ï¼Œå¦‚â€œæ­£â€ã€â€œåˆä¸€â€ï¼‰
      // è¿™é‡Œæˆ‘ä»¬éœ€è¦å°†æ•°å­—è½¬ä¸ºæ¨¡å—å¯¹åº”çš„æ±‰å­—è¿›è¡Œæ¯”å¯¹
      const monthNames = ['æ­£', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å', 'å†¬', 'è…Š'];
      const targetMonth = monthNames[lunarMonth - 1];
      
      if (res.lunarMonth === targetMonth && getLunarDayNum(res.lunarDay) === lunarDay) {
        return d;
      }
    }
    return null;
  };

  let s = findInYear(currentYear);
  if (!s || s < new Date(now.setHours(0,0,0,0))) {
    s = findInYear(currentYear + 1);
  }
  return s;
}

// è¾…åŠ©ï¼šå°†æ¨¡å—è¿”å›çš„æ±‰å­—æ—¥æœŸï¼ˆå¦‚â€œåˆåâ€ã€â€œå»¿äº”â€ï¼‰è½¬å›æ•°å­—
function getLunarDayNum(dayStr) {
  const dict = {"ä¸€":1,"äºŒ":2,"ä¸‰":3,"å››":4,"äº”":5,"å…­":6,"ä¸ƒ":7,"å…«":8,"ä¹":9,"å":10,"åˆ":0,"å»¿":20,"å…":30};
  if (dayStr === "åˆå") return 10;
  if (dayStr === "äºŒå") return 20;
  if (dayStr === "ä¸‰å") return 30;
  let res = dict[dayStr[0]] + dict[dayStr[1]];
  return res;
}

// --- UI ç»˜åˆ¶éƒ¨åˆ† (iPhone 13 ä¼˜åŒ–å¸ƒå±€) ---
async function createWidget() {
  const w = new ListWidget();
  const now = new Date();
  now.setHours(0,0,0,0);
  
  let todayPerson = null;
  const data = familyData.map(p => {
    const s = getNextSolarDate(p.m, p.d);
    const isT = s && (now.getTime() === s.getTime());
    if(isT) todayPerson = p;
    return {...p, s, isT};
  });

  w.backgroundColor = todayPerson ? new Color("#b31217") : new Color("#1c1c1e");
  w.setPadding(10, 4, 10, 4);
  const mainStack = w.addStack();

  data.forEach((p, i) => {
    const col = mainStack.addStack();
    col.layoutVertically();
    
    // 1. å¤´åƒ
    const eStack = col.addStack();
    eStack.addSpacer();
    const tEmoji = eStack.addText(p.e);
    tEmoji.font = Font.systemFont(45);
    eStack.addSpacer();
    
    col.addSpacer(10); // ç‰©ç†é—´è·éš”ç¦»

    // 2. ç»˜å›¾åŒº (åœ†å¼§ + æ—¥æœŸ)
    const cv = new DrawContext();
    cv.size = new Size(200, 200);
    cv.opaque = false;
    const center = {x: 100, y: 90}, radius = 75, thick = 12;
    const diff = p.s ? (p.s - now)/(24*3600*1000) : 0;
    const progress = p.isT ? 1 : Math.max(0.1, 1 - (diff/365));

    cv.setFillColor(new Color("#ffffff", 0.15));
    for(let a=190; a<=350; a+=5){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }
    cv.setFillColor(p.isT ? Color.green() : Color.yellow());
    for(let a=190; a<=190+(160*progress); a+=4){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }

    // 3. æ—¥æœŸ (Heavy è¶…å¤§å·)
    const df = new DateFormatter(); df.dateFormat = "MM-dd";
    cv.setFont(Font.heavySystemFont(32));
    cv.setTextColor(Color.white());
    cv.setTextAlignedCenter();
    cv.drawTextInRect(p.isT ? "BIRTH" : (p.s ? df.string(p.s) : "--"), new Rect(0, 105, 200, 60));

    const img = col.addImage(cv.getImage());
    img.imageSize = new Size(82, 82);
    
    if(i < data.length-1) mainStack.addSpacer();
  });

  // åº•éƒ¨å¹´åº¦è¿›åº¦
  w.addSpacer();
  const yp = (now - new Date(now.getFullYear(),0,1))/(365*24*3600*1000);
  const btm = w.addStack(); btm.layoutVertically(); btm.setPadding(0, 15, 5, 15);
  const t = btm.addText(`${now.getFullYear()} è¿›åº¦ ${Math.floor(yp*100)}%`);
  t.font = Font.boldSystemFont(13); t.textColor = Color.white();
  btm.addSpacer(5);
  const bc = new DrawContext(); bc.size = new Size(330, 12);
  bc.setFillColor(new Color("#ffffff", 0.2)); bc.fillPath(new Path().addRoundedRect(new Rect(0,0,330,12),6,6));
  bc.setFillColor(todayPerson ? Color.yellow() : Color.green()); bc.fillPath(new Path().addRoundedRect(new Rect(0,0,330*yp,12),6,6));
  btm.addImage(bc.getImage());

  return w;
}

// ç®¡ç†åå°
async function showControlPanel() {
  const a = new Alert(); a.title = "ğŸ‚ ç”Ÿæ—¥ç®¡å®¶ V5.0";
  familyData.forEach(p => a.addAction(`${p.e} ${p.name}`));
  a.addAction("ğŸ‘€ é¢„è§ˆç»„ä»¶"); a.addDestructiveAction("ğŸ”„ æ›´æ–°è„šæœ¬");
  const i = await a.presentSheet();
  if(i === familyData.length) { (await createWidget()).presentMedium(); }
  else if(i === familyData.length + 1) { 
    let r = new Request(GITHUB_URL);
    try {
      let c = await r.loadString();
      if(c.includes("Script.setWidget")) {
        fm.writeString(module.filename, c);
        const ok = new Alert(); ok.title="æ›´æ–°æˆåŠŸ"; await ok.present();
      }
    } catch(e) {}
  }
}

if(!config.runsInApp) {
  const w = await createWidget(); Script.setWidget(w); Script.complete();
} else { await showControlPanel(); }
