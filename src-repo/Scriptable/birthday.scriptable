// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: teal; icon-glyph: cake;

// --- 1. å¤–éƒ¨ä¾èµ–ç»Ÿä¸€å£°æ˜ (ç¡®ä¿ä½ çš„ Scriptable ç›®å½•ä¸‹æœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶) ---
const DmYY = importModule('DmYY'); 
const Lunar = importModule('lunar'); 

// --- 2. ç”Ÿæ—¥å°ç»„ä»¶ç±» ---
class FamilyBirthday extends DmYY {
  constructor(arg) {
    // è¿™é‡Œåªä¿ç•™ä½ éœ€è¦é…ç½®çš„é¡¹
    const defaultSettings = {
      family: [
        { name: "çˆ¸çˆ¸", month: 3, day: 15, emoji: "ğŸ‘¨" },
        { name: "å¦ˆå¦ˆ", month: 6, day: 20, emoji: "ğŸ‘©" },
        { name: "å¦¹å¦¹", month: 9, day: 5,  emoji: "ğŸ‘§" },
        { name: "æˆ‘",   month: 11, day: 8,  emoji: "ğŸ‘¦" }
      ]
    };
    super(arg, defaultSettings);
  }

  // é…ç½®ç•Œé¢ (DmYY é£æ ¼)
  async showMyMenu() {
    const actions = this.settings.family.map((p, i) => ({
      title: `${p.emoji} è®¾ç½® ${p.name} çš„å†œå†ç”Ÿæ—¥`,
      onClick: async () => {
        const a = new Alert();
        a.title = `è®¾ç½® ${p.name}`;
        a.addTextField("å¤´åƒ Emoji", p.emoji);
        a.addTextField("å†œå†æœˆä»½", p.month.toString());
        a.addTextField("å†œå†æ—¥æœŸ", p.day.toString());
        a.addAction("ä¿å­˜");
        a.addCancelAction("å–æ¶ˆ");
        if (await a.present() === 0) {
          this.settings.family[i].emoji = a.textFieldValue(0);
          this.settings.family[i].month = parseInt(a.textFieldValue(1));
          this.settings.family[i].day = parseInt(a.textFieldValue(2));
          this.saveSettings();
        }
      }
    }));
    await this.registerAction('ğŸ‚ ç”Ÿæ—¥é…ç½®é¢æ¿', actions);
    return await this.renderAction();
  }

  // æ¸²æŸ“é€»è¾‘
  async render() {
    const listWidget = new ListWidget();
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // è®¡ç®—å››äººæ—¥æœŸ
    let bDayPerson = null;
    const processed = this.settings.family.map(p => {
      // æ ¸å¿ƒä¿®æ­£ï¼šä¼˜å…ˆæ‰¾ 2025 å¹´
      let solar = this.getSolar(2025, p.month, p.day);
      // å¦‚æœ 2025 å¹´çš„å·²ç»è¿‡å®Œäº†ï¼Œå†æ‰¾ 2026 å¹´
      if (today.getTime() > solar.getTime()) {
        solar = this.getSolar(2026, p.month, p.day);
      }
      
      const isToday = today.toDateString() === solar.toDateString();
      if (isToday) bDayPerson = p;
      return { ...p, solar, isToday };
    });

    // å…¨å±€èƒŒæ™¯
    listWidget.backgroundColor = bDayPerson ? new Color("#b31217") : new Color("#1c1c1e");
    listWidget.setPadding(12, 12, 12, 12);

    const hStack = listWidget.addStack();
    hStack.layoutHorizontally();
    hStack.bottomAlignContent();

    processed.forEach((p, i) => {
      const vStack = hStack.addStack();
      vStack.layoutVertically();
      vStack.centerAlignContent();

      // åœ¨ 120x120 çš„å›ºå®šç”»å¸ƒä¸Šç»˜åˆ¶ï¼Œç¡®ä¿æ°¸ä¸å¯¹é½é”™ä½
      const canvas = new DrawContext();
      canvas.size = new Size(120, 140); // ç¨å¾®åŠ é«˜ç”»å¸ƒç»™æ–‡å­—ç•™ç©ºé—´
      canvas.opaque = false;
      
      // 1. ç»˜å¤´åƒ (å±…ä¸­é é¡¶)
      canvas.setFont(Font.systemFont(36));
      canvas.setTextAlignedCenter();
      canvas.drawTextInRect(p.emoji, new Rect(0, 0, 120, 50));

      // 2. ç»˜åœ†ç¯ (åŒ…è£¹å¤´åƒä¸‹æ–¹)
      const diff = p.solar - now;
      const progress = p.isToday ? 1 : Math.max(0.1, 1 - (diff / (365 * 86400000)));
      this.drawArc(canvas, progress, p.isToday);

      const img = vStack.addImage(canvas.getImage());
      img.imageSize = new Size(72, 84);

      vStack.addSpacer(2);

      // 3. ç»˜æ—¥æœŸæ–‡å­— (YYYY-MM-DD)
      const df = new DateFormatter();
      df.dateFormat = "yyyy-MM-dd";
      const t = vStack.addText(p.isToday ? "BIRTHDAY" : df.string(p.solar));
      t.font = Font.boldSystemFont(9);
      t.textColor = Color.white();
      t.centerAlignText();

      if (i < processed.length - 1) hStack.addSpacer();
    });

    listWidget.addSpacer();
    
    // åº•éƒ¨å¹´åº¦è¿›åº¦æ¡
    this.drawYearProgress(listWidget, bDayPerson);

    return listWidget;
  }

  // ç»˜å›¾è¾…åŠ©ï¼šåœ†ç¯åæ ‡å¯¹é½
  drawArc(ctx, progress, isToday) {
    const center = { x: 60, y: 92 }; // ç²¾ç¡®è°ƒæ•´çš„ä¸­å¿ƒç‚¹
    const radius = 38;
    const thick = 6;
    
    // èƒŒæ™¯ç¯
    ctx.setFillColor(new Color("#ffffff", 0.15));
    for (let a=0; a<360; a+=3) {
      const x = center.x + radius * Math.cos(a * Math.PI / 180);
      const y = center.y + radius * Math.sin(a * Math.PI / 180);
      ctx.fillEllipse(new Rect(x - thick/2, y - thick/2, thick, thick));
    }
    
    // è¿›åº¦ç¯ (ä»å·¦ä¾§ 180åº¦ å¼€å§‹é¡ºæ—¶é’ˆç»˜åˆ¶)
    ctx.setFillColor(isToday ? Color.green() : Color.yellow());
    for (let a=180; a < 180 + (180 * progress); a+=3) {
      const x = center.x + radius * Math.cos(a * Math.PI / 180);
      const y = center.y + radius * Math.sin(a * Math.PI / 180);
      ctx.fillEllipse(new Rect(x - thick/2, y - thick/2, thick, thick));
    }
  }

  // å¹´åº¦è¿›åº¦æ¡ç»˜åˆ¶
  drawYearProgress(w, isBday) {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const end = new Date(now.getFullYear() + 1, 0, 1);
    const yp = (now - start) / (end - start);
    
    const stack = w.addStack();
    stack.layoutVertically();
    
    const label = stack.addText(`${now.getFullYear()} å¹´è¿›åº¦: ${Math.floor(yp*100)}%`);
    label.font = Font.systemFont(10);
    label.textColor = Color.white();
    label.textOpacity = 0.5;
    
    stack.addSpacer(4);
    
    const barW = 310;
    const ctx = new DrawContext();
    ctx.size = new Size(barW, 10);
    ctx.opaque = false;
    
    const bgP = new Path(); bgP.addRoundedRect(new Rect(0,0,barW,10),5,5);
    ctx.addPath(bgP); ctx.setFillColor(new Color("#ffffff",0.12)); ctx.fillPath();
    
    const fgP = new Path(); fgP.addRoundedRect(new Rect(0,0,barW*yp,10),5,5);
    ctx.addPath(fgP); ctx.setFillColor(isBday ? Color.yellow() : Color.green()); ctx.fillPath();
    
    stack.addImage(ctx.getImage());
  }

  // å†œå†è½¬å…¬å†å·¥å…·
  getSolar(y, m, d) {
    const s = Lunar.toSolar(y, m, d);
    return new Date(s.year, s.month - 1, s.day);
  }
}

// --- 3. è¿è¡Œè„šæœ¬ ---
const widget = new FamilyBirthday(args.widgetParameter);
if (config.runsInApp) {
  await widget.showMyMenu();
} else {
  const w = await widget.render();
  Script.setWidget(w);
}
Script.complete();
