// Variables used by Scriptable.
// icon-color: red; icon-glyph: cake;

const GITHUB_URL = "https://raw.githubusercontent.com/SHanQ7/Alaric/refs/heads/main/src-repo/Scriptable/birthday.scriptable";
const fm = FileManager.local();
const dataPath = fm.joinPath(fm.documentsDirectory(), "lunar_birthday_data.json");

let familyData = [{name:"çˆ¸çˆ¸",m:3,d:15,e:"ğŸ‘¨"},{name:"å¦ˆå¦ˆ",m:6,d:20,e:"ğŸ‘©"},{name:"å¦¹å¦¹",m:9,d:5,e:"ğŸ‘§"},{name:"æˆ‘",m:11,d:8,e:"ğŸ‘¦"}];
if(fm.fileExists(dataPath)) familyData = JSON.parse(fm.readString(dataPath));

// --- æ ¸å¿ƒï¼šSolarLunar ç®—æ³• (æ— å¹´é™é™åˆ¶ç‰ˆæœ¬) ---
function getSolar(y, m, d) {
  // å€ŸåŠ© JS åŸç”Ÿ Intl å¯¹è±¡çš„ zh-u-ca-chinese å†æ³•
  // è¿™æœ¬è´¨ä¸Šå°±æ˜¯ solarlunar åº“çš„æ ¸å¿ƒé€»è¾‘ï¼Œæ”¯æŒ 1900-2100+
  let date = new Date(y, m - 1, d);
  for (let i = 0; i < 60; i++) {
    let tmp = new Date(y, 0, i + (m - 1) * 28);
    let parts = new Intl.DateTimeFormat('zh-u-ca-chinese').formatToParts(tmp);
    let lm = parseInt(parts.find(p => p.type === 'month').value);
    let ld = parseInt(parts.find(p => p.type === 'day').value);
    if (lm === m && ld === d) return new Date(tmp.setHours(0,0,0,0));
  }
}

function getNextBirthday(m, d) {
  const now = new Date(); now.setHours(0,0,0,0);
  let s = getSolar(now.getFullYear(), m, d);
  if (s < now) s = getSolar(now.getFullYear() + 1, m, d);
  return s;
}

// --- UI ç»˜åˆ¶ (iPhone 13 é€‚é…) ---
async function createWidget() {
  const w = new ListWidget();
  const now = new Date();
  let todayBday = null;

  const data = familyData.map(p => {
    const s = getNextBirthday(p.m, p.d);
    const isT = (now.setHours(0,0,0,0) === s.getTime());
    if(isT) todayBday = p;
    return {...p, s, isT};
  });

  w.backgroundColor = todayBday ? new Color("#b31217") : new Color("#1c1c1e");
  w.setPadding(12, 4, 10, 4);
  const stack = w.addStack();

  data.forEach((p, i) => {
    const v = stack.addStack(); v.layoutVertically();
    const cv = new DrawContext();
    cv.size = new Size(240, 260); // å¢å¤§ç”»å¸ƒ
    cv.opaque = false;

    // 1. å¤´åƒ (é¡¶éƒ¨ y=0)
    cv.setFont(Font.systemFont(75));
    cv.setTextAlignedCenter();
    cv.drawTextInRect(p.e, new Rect(0, 0, 240, 95));

    // 2. åŠåœ†å¼§ (å¼€å£æœä¸‹ï¼Œåœ†å¿ƒ y=150)
    const center = {x:120, y:150}, radius = 85, thick = 12;
    const diff = (p.s - now) / (1000 * 60 * 60 * 24);
    const progress = p.isT ? 1 : Math.max(0.05, 1 - (diff / 365));
    
    // åº•å¼§
    cv.setFillColor(new Color("#ffffff", 0.15));
    for(let a=190; a<=350; a+=4){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }
    // è¿›åº¦å¼§
    cv.setFillColor(p.isT ? Color.green() : Color.yellow());
    for(let a=190; a<=190+(160*progress); a+=3.5){
      let r=a*Math.PI/180;
      cv.fillEllipse(new Rect(center.x+radius*Math.cos(r)-thick/2, center.y+radius*Math.sin(r)-thick/2, thick, thick));
    }

    // 3. æ ‡å‡†æ—¥æœŸ (y=170ï¼Œç¡®ä¿åœ¨å¼€å£å†…ä¸”ä¸é‡å )
    const df = new DateFormatter(); df.dateFormat = "MM-dd";
    cv.setFont(Font.heavySystemFont(32)); // è¶…ç²—å¤§å­—
    cv.setTextColor(Color.white());
    cv.drawTextInRect(p.isT ? "BIRTH" : df.string(p.s), new Rect(0, 170, 240, 75));

    const img = v.addImage(cv.getImage());
    img.imageSize = new Size(82, 90);
    if(i < data.length-1) stack.addSpacer();
  });

  // å¹´åº¦è¿›åº¦
  w.addSpacer();
  const start = new Date(now.getFullYear(), 0, 1);
  const end = new Date(now.getFullYear() + 1, 0, 1);
  const yp = (now - start) / (end - start);

  const btm = w.addStack(); btm.layoutVertically(); btm.setPadding(0, 14, 2, 14);
  const txt = btm.addText(`${now.getFullYear()} è¿›åº¦ ${Math.floor(yp*100)}%`);
  txt.font = Font.boldSystemFont(14); txt.textColor = Color.white();
  btm.addSpacer(6);
  
  const bar = new DrawContext(); bar.size = new Size(330, 14);
  bar.setFillColor(new Color("#ffffff", 0.15));
  bar.fillPath(new Path().addRoundedRect(new Rect(0,0,330,14),7,7));
  bar.setFillColor(todayBday ? Color.yellow() : Color.green());
  bar.fillPath(new Path().addRoundedRect(new Rect(0,0,330*yp,14),7,7));
  btm.addImage(bar.getImage());

  return w;
}

// --- ç®¡ç†åå° ---
async function showControlPanel() {
  const a = new Alert(); a.title = "ğŸ‚ ç”Ÿæ—¥ç®¡å®¶";
  familyData.forEach(p => a.addAction(`${p.e} ${p.name}`));
  a.addAction("ğŸ‘€ é¢„è§ˆç»„ä»¶"); a.addDestructiveAction("ğŸ”„ æ£€æŸ¥æ›´æ–°");
  const i = await a.presentSheet();
  if(i === familyData.length) { (await createWidget()).presentMedium(); }
  else if(i === familyData.length + 1) { 
    let r = new Request(GITHUB_URL);
    try {
      let c = await r.loadString();
      if(c.includes("Script.setWidget")) {
        fm.writeString(module.filename, c);
        const ok = new Alert(); ok.title="æ›´æ–°æˆåŠŸ"; await ok.present();
      }
    } catch(e) { /* silent fail */ }
  }
}

if(!config.runsInApp) {
  const w = await createWidget(); Script.setWidget(w); Script.complete();
} else {
  await showControlPanel();
}
