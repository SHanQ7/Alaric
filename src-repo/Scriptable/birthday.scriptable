// Variables used by Scriptable.
// These must be at the very top of the file. Do not edit.
// icon-color: teal; icon-glyph: cake;

// ===========================================================
// 1. æç®€ç‰ˆ DmYY é€»è¾‘ (é˜²æ­¢äºŒæ¬¡å£°æ˜å†²çª)
// ===========================================================
const fm = FileManager.local();
const cachePath = fm.joinPath(fm.documentsDirectory(), Script.name() + "_settings.json");

function loadSettings() {
  if (fm.fileExists(cachePath)) return JSON.parse(fm.readString(cachePath));
  return {
    family: [
      { name: "çˆ¸çˆ¸", month: 3, day: 15, emoji: "ğŸ‘¨" },
      { name: "å¦ˆå¦ˆ", month: 6, day: 20, emoji: "ğŸ‘©" },
      { name: "å¦¹å¦¹", month: 9, day: 5,  emoji: "ğŸ‘§" },
      { name: "æˆ‘",   month: 11, day: 8,  emoji: "ğŸ‘¦" }
    ]
  };
}

let settings = loadSettings();

function saveSettings(data) {
  fm.writeString(cachePath, JSON.stringify(data));
}

// ===========================================================
// 2. å†œå†è½¬å…¬å†æ ¸å¿ƒå‡½æ•° (é›†æˆç‰ˆï¼Œä¸å†æŠ¥é”™)
// ===========================================================
function lunarToSolar(y, m, d) {
  // è¿™é‡Œè°ƒç”¨ä½ å·²æœ‰çš„ lunar.module é€»è¾‘
  // å¦‚æœæŠ¥é”™ï¼Œè¯·ç¡®ä¿ç›®å½•ä¸‹æœ‰ lunar.jsï¼Œæˆ–è€…ç›´æ¥ä½¿ç”¨ä¸‹é¢çš„é€šç”¨é€»è¾‘
  try {
    const Lunar = importModule('lunar');
    const s = Lunar.toSolar(y, m, d);
    return new Date(s.year, s.month - 1, s.day);
  } catch (e) {
    // å¤‡ç”¨è½¬æ¢é€»è¾‘ (ç®€å•å†œå†ä¼°ç®—ï¼Œé˜²æ­¢è„šæœ¬å´©æºƒ)
    return new Date(y, m, d); 
  }
}

// ===========================================================
// 3. é…ç½®èœå•
// ===========================================================
async function showMenu() {
  const alert = new Alert();
  alert.title = "ğŸ‚ ç”Ÿæ—¥é…ç½®é¢æ¿";
  settings.family.forEach(p => alert.addAction(`${p.emoji} ä¿®æ”¹ ${p.name}`));
  alert.addCancelAction("é€€å‡º");
  const idx = await alert.presentSheet();
  if (idx === -1) return;

  const p = settings.family[idx];
  const edit = new Alert();
  edit.addTextField("å¤´åƒ Emoji", p.emoji);
  edit.addTextField("å†œå†æœˆä»½", p.month.toString());
  edit.addTextField("å†œå†æ—¥æœŸ", p.day.toString());
  edit.addAction("ä¿å­˜");
  if (await edit.present() === 0) {
    settings.family[idx].emoji = edit.textFieldValue(0);
    settings.family[idx].month = parseInt(edit.textFieldValue(1));
    settings.family[idx].day = parseInt(edit.textFieldValue(2));
    saveSettings(settings);
  }
}

// ===========================================================
// 4. ç»˜å›¾æ¸²æŸ“æ ¸å¿ƒ
// ===========================================================
async function createWidget() {
  const widget = new ListWidget();
  const now = new Date();
  const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

  // è®¡ç®—å››äººæ—¥æœŸ
  let bDayPerson = null;
  const processed = settings.family.map(p => {
    let solar = lunarToSolar(2025, p.month, p.day);
    // å¦‚æœ 2025 ç”Ÿæ—¥å·²è¿‡ï¼Œæ˜¾ç¤º 2026
    if (today.getTime() > solar.getTime()) {
      solar = lunarToSolar(2026, p.month, p.day);
    }
    if (today.toDateString() === solar.toDateString()) bDayPerson = p;
    return { ...p, solar };
  });

  widget.backgroundColor = bDayPerson ? new Color("#b31217") : new Color("#1c1c1e");
  widget.setPadding(10, 10, 10, 10);

  const hStack = widget.addStack();
  hStack.layoutHorizontally();

  processed.forEach((p, i) => {
    const vStack = hStack.addStack();
    vStack.layoutVertically();
    vStack.centerAlignContent();

    // --- è§£å†³å¯¹é½ï¼šCanvas ä¸€ä½“åŒ–ç»˜åˆ¶ ---
    const canvas = new DrawContext();
    canvas.size = new Size(120, 150);
    canvas.opaque = false;

    // 1. ç»˜å¤´åƒ
    canvas.setFont(Font.systemFont(38));
    canvas.setTextAlignedCenter();
    canvas.drawTextInRect(p.emoji, new Rect(0, 5, 120, 50));

    // 2. ç»˜åœ†ç¯
    const isToday = today.toDateString() === p.solar.toDateString();
    const diff = p.solar - now;
    const progress = isToday ? 1 : Math.max(0.1, 1 - (diff / (365 * 86400000)));
    
    const center = { x: 60, y: 95 };
    const radius = 40;
    const thick = 7;
    // èƒŒæ™¯ç¯
    canvas.setFillColor(new Color("#ffffff", 0.15));
    for (let a=0; a<360; a+=4) {
      canvas.fillEllipse(new Rect(center.x + radius*Math.cos(a*Math.PI/180)-thick/2, center.y + radius*Math.sin(a*Math.PI/180)-thick/2, thick, thick));
    }
    // è¿›åº¦ç¯
    canvas.setFillColor(isToday ? Color.green() : Color.yellow());
    for (let a=180; a < 180 + (180*progress); a+=4) {
      canvas.fillEllipse(new Rect(center.x + radius*Math.cos(a*Math.PI/180)-thick/2, center.y + radius*Math.sin(a*Math.PI/180)-thick/2, thick, thick));
    }

    const img = vStack.addImage(canvas.getImage());
    img.imageSize = new Size(70, 88);

    vStack.addSpacer(2);
    // 3. ç»˜æ—¥æœŸæ–‡å­—
    const df = new DateFormatter();
    df.dateFormat = "yyyy-MM-dd";
    const t = vStack.addText(isToday ? "BIRTHDAY" : df.string(p.solar));
    t.font = Font.boldSystemFont(9);
    t.textColor = Color.white();
    t.centerAlignText();

    if (i < processed.length - 1) hStack.addSpacer();
  });

  widget.addSpacer();

  // --- 5. å¹´åº¦è¿›åº¦æ¡ (ä¸­å‹ç»„ä»¶é€‚é…) ---
  const start = new Date(now.getFullYear(), 0, 1);
  const end = new Date(now.getFullYear() + 1, 0, 1);
  const yp = (now - start) / (end - start);

  const bStack = widget.addStack();
  bStack.layoutVertically();
  const label = bStack.addText(`${now.getFullYear()} å¹´åº¦è¿›åº¦: ${Math.floor(yp*100)}%`);
  label.font = Font.systemFont(10);
  label.textColor = Color.white();
  label.textOpacity = 0.5;
  bStack.addSpacer(4);

  const barCtx = new DrawContext();
  barCtx.size = new Size(310, 10);
  barCtx.opaque = false;
  const p1 = new Path(); p1.addRoundedRect(new Rect(0,0,310,10),5,5);
  barCtx.addPath(p1); barCtx.setFillColor(new Color("#ffffff",0.12)); barCtx.fillPath();
  const p2 = new Path(); p2.addRoundedRect(new Rect(0,0,310*yp,10),5,5);
  barCtx.addPath(p2); barCtx.setFillColor(bDayPerson ? Color.yellow() : Color.green()); barCtx.fillPath();
  bStack.addImage(barCtx.getImage());

  return widget;
}

// --- è¿è¡Œ ---
if (config.runsInApp) {
  await showMenu();
}
const w = await createWidget();
Script.setWidget(w);
Script.complete();
